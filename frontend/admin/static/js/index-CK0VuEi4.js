var Z=Object.defineProperty,ee=Object.defineProperties;var te=Object.getOwnPropertyDescriptors;var $=Object.getOwnPropertySymbols;var ae=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable;var E=(e,n,r)=>n in e?Z(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r,M=(e,n)=>{for(var r in n||(n={}))ae.call(n,r)&&E(e,r,n[r]);if($)for(var r of $(n))ne.call(n,r)&&E(e,r,n[r]);return e},I=(e,n)=>ee(e,te(n));import{P as le,a as oe}from"./plus-search-C8us3IWA.js";import{l as re,S as se}from"./vue-json-pretty-CdcdLoTu.js";import{d as j,r as C,h as v,c as D,e as w,f as i,w as p,i as a,F as ce,G as ie,E as ue,s as R,k,l as pe,o as de,t as me,n as fe,m as b,aK as ge,p as he,C as be,J as ve,v as H,j as ye,x as _e,y as Ce,z as ke,A as S,B as Se,_ as xe}from"./index-CCAdPrhE.js";import{c as we}from"./utils-qEEvAZny.js";import{g as Re}from"./datePicker-WHgduTab.js";import{u as De}from"./hooks-Dsu0KDXM.js";import{C as Te}from"./close-bold-jsUwmjP8.js";import"./index-4IH4PzWT.js";import"./epTheme-By0FjaSh.js";const Ye=j({__name:"detail",props:{data:{type:Object,default:()=>({})}},setup(e){const n=e,r=[{label:"ID",prop:"id"},{label:"关联ID",prop:"task_id"},{label:"动作",prop:"action"},{label:"状态",prop:"status"},{label:"执行次数",prop:"attempts"},{label:"来源",prop:"source"},{label:"开始时间",prop:"started_at",cellRenderer:({started_at:c})=>c?R(c).format("YYYY-MM-DD HH:mm:ss"):"-"},{label:"最后执行时间",prop:"last_execute_at",cellRenderer:({last_execute_at:c})=>c?R(c).format("YYYY-MM-DD HH:mm:ss"):"-"},{label:"创建时间",prop:"created_at",cellRenderer:({created_at:c})=>c?R(c).format("YYYY-MM-DD HH:mm:ss"):"-"}],u=C([{title:"响应",name:"result",data:n.data.result}]);return(c,x)=>{const y=v("el-scrollbar"),l=v("el-tab-pane"),o=v("el-tabs");return w(),D("div",null,[i(y,null,{default:p(()=>[i(a(re),{border:"",data:[e.data],columns:r,column:5},null,8,["data"])]),_:1}),i(o,{modelValue:u.value[0].name,type:"border-card",class:"mt-4"},{default:p(()=>[(w(!0),D(ce,null,ie(u.value,(m,g)=>(w(),ue(l,{key:g,name:m.name,label:m.title},{default:p(()=>[i(y,{"max-height":"calc(100vh - 240px)"},{default:p(()=>[i(a(se),{data:m.data,"onUpdate:data":f=>m.data=f},null,8,["data","onUpdate:data"])]),_:2},1024)]),_:2},1032,["name","label"]))),128))]),_:1},8,["modelValue"])])}}});function Pe(e){return k.get("/task",{params:e})}function ze(e){return k.get(`/task/${e}`)}function Be(e){return k.post("/task/batch-start",{data:{ids:e}})}function Me(e){return k.post("/task/batch-stop",{data:{ids:e}})}function Ie(e){return k.post("/task/batch-execute",{data:{ids:e}})}function He(e){return k.delete(`/task/${e}`)}function Ve(e){return k.delete("/task/batch",{data:{ids:e}})}function $e(){const e=C({}),n=C(),r=C([]),u=C(!0),c=pe({total:0,pageSize:10,currentPage:1,background:!0,pageSizes:[10,20,50,100]});function x(t){c.pageSize=t,o()}function y(t){c.currentPage=t,o()}function l(t){ze(t.id).then(d=>{ge({title:"任务详情",fullscreen:!0,hideFooter:!0,contentRenderer:()=>Ye,props:{data:d.data}})})}function o(){u.value=!0;const t=I(M({},me(e.value)),{pageSize:c.pageSize,currentPage:c.currentPage});t.created_at&&(t.created_at=we(t.created_at)),Pe(t).then(({data:d})=>{r.value=d.items,c.total=d.total,c.pageSize=d.pageSize,c.currentPage=d.currentPage,fe(()=>{n.value&&n.value.getTableRef().clearSelection()})}).finally(()=>{u.value=!1})}const m=()=>{e.value={},o()},g=()=>{setTimeout(()=>{var t,d;window.dispatchEvent(new Event("resize")),(d=(t=n.value)==null?void 0:t.setAdaptive)==null||d.call(t)},500)},f=t=>{u.value=!0,He(t.id).then(()=>{b("删除成功",{type:"success"}),o()}).finally(()=>{u.value=!1})},T=t=>{if(!t||t.length===0){b("请选择要操作的任务",{type:"warning"});return}u.value=!0,Be(t).then(()=>{b("启动成功",{type:"success"}),o()}).finally(()=>{u.value=!1})},Y=t=>{if(!t||t.length===0){b("请选择要操作的任务",{type:"warning"});return}u.value=!0,Me(t).then(()=>{b("停止成功",{type:"success"}),o()}).finally(()=>{u.value=!1})},P=t=>{if(!t||t.length===0){b("请选择要操作的任务",{type:"warning"});return}u.value=!0,Ie(t).then(()=>{b("执行成功",{type:"success"}),o()}).finally(()=>{u.value=!1})},z=t=>{if(!t||t.length===0){b("请选择要删除的任务",{type:"warning"});return}u.value=!0,Ve(t).then(()=>{b("删除成功",{type:"success"}),o()}).finally(()=>{u.value=!1})};return de(()=>{o()}),{tableRef:n,form:e,loading:u,dataList:r,pagination:c,onSearch:o,onResetSearch:m,onCollapse:g,onDelete:f,onDetail:l,onBatchStart:T,onBatchStop:Y,onBatchExecute:P,handleBatchDestroy:z,handleSizeChange:x,handleCurrentChange:y}}const A={commit:"提交",sync:"同步",revalidate:"验证",cancel:"取消",callback:"回调",sendActive:"签发邮件",sendExpire:"续期邮件"},Ee=Object.entries(A).map(([e,n])=>({label:n,value:e})),Oe={commit:"primary",sync:"primary",revalidate:"primary",cancel:"danger",callback:"primary",sendActive:"success",sendExpire:"warning"},L={executing:"执行中",successful:"成功",failed:"失败",stopped:"停止"},je=Object.entries(L).map(([e,n])=>({label:n,value:e})),Ae={executing:"primary",successful:"success",failed:"danger",stopped:"warning"};function Le(e){return A[e]||e}function Ne(e){return Oe[e]||"info"}function We(e){return L[e]||e}function Fe(e){return Ae[e]||"info"}function Ue(e){const n=he(()=>{e()},500);return[{label:"动作",prop:"action",valueType:"select",options:Ee,fieldProps:{placeholder:"请选择动作"},onChange:()=>{n()}},{label:"状态",prop:"status",valueType:"select",options:je,fieldProps:{placeholder:"请选择状态"},onChange:()=>{n()}},{label:"来源",prop:"source",valueType:"input",fieldProps:{placeholder:"请输入来源"}},{label:"任务ID",prop:"task_id",valueType:"input",fieldProps:{placeholder:"请输入任务ID"}},{label:"创建时间",prop:"created_at",valueType:"date-picker",fieldProps:{type:"daterange",rangeSeparator:"至",startPlaceholder:"开始日期",endPlaceholder:"结束日期",valueFormat:"YYYY-MM-DD",shortcuts:Re()}}]}function O(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!ve(e)}const qe=()=>{const e=C(),n=C([]),r=be();return{tableRef:e,selectedIds:n,tableColumns:[{label:"勾选列",type:"selection",width:30,reserveSelection:!0},{label:"ID",prop:"id",width:60},{label:"任务ID",prop:"task_id",minWidth:100,cellRenderer:({row:l})=>i("span",{class:"cursor-pointer",onClick:()=>{r.push({path:["sendActive","sendExpire"].includes(l.action)?"/user":"/order",query:{id:l.task_id}})}},[l.task_id])},{label:"动作",prop:"action",minWidth:100,cellRenderer:({row:l})=>{let o;return i(v("el-tag"),{type:Ne(l.action)},O(o=Le(l.action))?o:{default:()=>[o]})}},{label:"状态",prop:"status",minWidth:100,cellRenderer:({row:l})=>{let o;return i(v("el-tag"),{type:Fe(l.status)},O(o=We(l.status))?o:{default:()=>[o]})}},{label:"执行次数",prop:"attempts",minWidth:120},{label:"权重",prop:"weight",minWidth:100},{label:"来源",prop:"source",width:100},{label:"开始时间",prop:"started_at",width:170,formatter:({started_at:l})=>l?R(l).format("YYYY-MM-DD HH:mm:ss"):"-"},{label:"最后执行时间",prop:"last_execute_at",width:170,formatter:({last_execute_at:l})=>l?R(l).format("YYYY-MM-DD HH:mm:ss"):"-"},{label:"操作",fixed:"right",slot:"operation",width:110}],handleSelectionChange:l=>{n.value=l.map(o=>o.id),e.value.setAdaptive()},handleSelectionCancel:()=>{var l;(l=e.value)==null||l.getTableRef().clearSelection()},handleRowClick:(l,o,m)=>{var f;const g=m.target;g.tagName==="BUTTON"||g.closest("button")||g.closest(".el-button")||(f=e.value)==null||f.getTableRef().toggleRowSelection(l)}}},Ge={class:"main"},Je={class:"search bg-bg_color w-[99/100] pl-4 pr-4 pt-[24px] pb-[24px] overflow-auto"},Ke={key:0,class:"bg-[var(--el-fill-color-light)] w-full h-[46px] mb-2 pl-3 pr-2 flex items-center"},Qe={class:"flex-auto"},Xe={style:{"font-size":"var(--el-font-size-base)"},class:"text-[rgba(42,46,54,0.5)] dark:text-[rgba(220,220,242,0.5)] ml-2"},Ze=j({name:"Task",__name:"index",setup(e){const{tableRef:n,selectedIds:r,tableColumns:u,handleSelectionChange:c,handleSelectionCancel:x,handleRowClick:y}=qe(),{form:l,loading:o,dataList:m,pagination:g,onSearch:f,onDetail:T,onDelete:Y,onResetSearch:P,onCollapse:z,onBatchStart:t,onBatchStop:d,onBatchExecute:N,handleBatchDestroy:W,handleSizeChange:F,handleCurrentChange:U}=$e(),q=Ue(f);return(et,s)=>{const _=v("el-button"),G=v("el-tooltip"),V=v("el-popconfirm"),J=v("pure-table"),K=Se("motion-fade");return w(),D("div",Ge,[H("div",Je,[i(a(le),{modelValue:a(l),"onUpdate:modelValue":s[0]||(s[0]=h=>ye(l)?l.value=h:null),columns:a(q),"show-number":2,"row-props":{gutter:12},"col-props":{xs:24,sm:12,md:8,lg:6,xl:4},"label-width":"80","label-position":"right","label-suffix":"","search-text":"搜索","reset-text":"重置","expand-text":"展开","retract-text":"收起",onSearch:a(f),onReset:a(P),onCollapse:a(z)},null,8,["modelValue","columns","onSearch","onReset","onCollapse"])]),i(a(oe),{title:"任务管理",columns:a(u),onRefresh:a(f)},{buttons:p(()=>[i(_,{type:"primary",onClick:s[1]||(s[1]=h=>a(t)(a(r)))},{default:p(()=>s[5]||(s[5]=[S(" 启动 ")])),_:1}),i(_,{type:"warning",onClick:s[2]||(s[2]=h=>a(d)(a(r)))},{default:p(()=>s[6]||(s[6]=[S(" 停止 ")])),_:1}),i(_,{type:"success",onClick:s[3]||(s[3]=h=>a(N)(a(r)))},{default:p(()=>s[7]||(s[7]=[S(" 执行 ")])),_:1})]),default:p(({size:h,dynamicColumns:Q})=>[a(r).length>0?_e((w(),D("div",Ke,[H("div",Qe,[i(G,{placement:"top",content:"取消选择"},{default:p(()=>[i(_,{type:"primary",size:"small",class:"!w-[15px] !p-0 !h-[15px] !rounded-[3px]",icon:a(De)(a(Te)),onClick:a(x)},null,8,["icon","onClick"])]),_:1}),H("span",Xe," 已选 "+ke(a(r).length)+" 项 ",1)]),i(V,{title:"确定要删除吗？",width:"160px",onConfirm:s[4]||(s[4]=B=>a(W)(a(r)))},{reference:p(()=>[i(_,{type:"danger",size:"small"},{default:p(()=>s[8]||(s[8]=[S(" 批量删除 ")])),_:1})]),_:1})])),[[K]]):Ce("",!0),i(J,{ref_key:"tableRef",ref:n,"row-key":"id","align-whole":"left","table-layout":"auto",loading:a(o),size:h,adaptive:"",adaptiveConfig:{offsetBottom:108},data:a(m),columns:Q,pagination:I(M({},a(g)),{size:h}),"header-cell-style":{background:"var(--el-fill-color-light)",color:"var(--el-text-color-primary)"},onRowClick:a(y),onSelectionChange:a(c),onPageSizeChange:a(F),onPageCurrentChange:a(U)},{operation:p(({row:B})=>[i(_,{class:"reset-margin !outline-none",link:"",type:"primary",size:h,onClick:X=>a(T)(B)},{default:p(()=>s[9]||(s[9]=[S(" 详情 ")])),_:2},1032,["size","onClick"]),i(V,{title:"确定要删除吗？",width:"160px",onConfirm:X=>a(Y)(B)},{reference:p(()=>[i(_,{class:"reset-margin !outline-none",link:"",type:"danger",size:h},{default:p(()=>s[10]||(s[10]=[S(" 删除 ")])),_:2},1032,["size"])]),_:2},1032,["onConfirm"])]),_:2},1032,["loading","size","data","columns","pagination","onRowClick","onSelectionChange","onPageSizeChange","onPageCurrentChange"])]),_:1},8,["columns","onRefresh"])])}}}),pt=xe(Ze,[["__scopeId","data-v-2d3275f9"]]);export{pt as default};
