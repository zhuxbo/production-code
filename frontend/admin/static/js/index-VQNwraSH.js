var Pe=Object.defineProperty,we=Object.defineProperties;var Fe=Object.getOwnPropertyDescriptors;var de=Object.getOwnPropertySymbols;var xe=Object.prototype.hasOwnProperty,Ie=Object.prototype.propertyIsEnumerable;var pe=(o,a,p)=>a in o?Pe(o,a,{enumerable:!0,configurable:!0,writable:!0,value:p}):o[a]=p,se=(o,a)=>{for(var p in a||(a={}))xe.call(a,p)&&pe(o,p,a[p]);if(de)for(var p of de(a))Ie.call(a,p)&&pe(o,p,a[p]);return o},ue=(o,a)=>we(o,Fe(a));import{P as Re,a as Te}from"./plus-search-BUQ-TqYT.js";import{k as ee,r as h,l as U,m as I,t as ze,n as $e,p as Be,f as r,s as Le,d as fe,D as me,q as Ne,E as L,e as v,w as u,h as V,x as ve,B as ge,v as c,y as X,c as w,i,A as T,G as q,F as N,z as H,_ as _e,o as Ue,j as je}from"./index-DGk0kt2J.js";import{_ as Z}from"./index.vue_vue_type_script_setup_true_lang-Bnlw5Vvy.js";import{p as be,a as Oe}from"./dictionary-CR5dJ5v0.js";import{s as De}from"./product-C9kh8rAp.js";import{b as Ee,i as qe}from"./userLevel-CB_Sc2Eq.js";import{u as Ae}from"./hooks-CKBD7cwG.js";import{C as We}from"./close-bold-eEJY7ty6.js";import"./index-BMoP5yWn.js";import"./epTheme-Dyb8RIzn.js";function Me(o){return ee.get("/product-price",{params:o})}function Ye(o){return ee.delete("/product-price/batch",{data:{ids:o}})}function Ke(o,a){return ee.get("/product-price/get",{params:{product_id:o,level_codes:a}})}function He(o,a){return ee.put("/product-price/set",{data:{product_id:o,product_price:a}})}function Ge(o){const a=h({}),p=h([]),y=h(!0),g=U({total:0,pageSize:10,currentPage:1,background:!0,pageSizes:[10,20,50,100]});function F(C){g.pageSize=C,P()}function n(C){g.currentPage=C,P()}const S=C=>{Ye(C).then(()=>{I("删除成功",{type:"success"}),P()})};function P(){y.value=!0;const C=ue(se({},ze(a.value)),{pageSize:g.pageSize,currentPage:g.currentPage});Me(C).then(({data:l})=>{p.value=l.items,g.total=l.total,g.pageSize=l.pageSize,g.currentPage=l.currentPage,$e(()=>{o.value&&o.value.getTableRef().clearSelection()})}).finally(()=>{y.value=!1})}return{loading:y,search:a,dataList:p,pagination:g,handleSizeChange:F,handleCurrentChange:n,onSearch:P,handleBatchDestroy:S}}const Je=o=>{const a=Be(()=>{o()},500);return{searchColumns:[{label:"产品",prop:"product_id",valueType:"select",fieldProps:{clearable:!0},renderField:(y,g)=>r(Z,{modelValue:y,uri:"/product",searchField:"quickSearch",labelField:"name",valueField:"id",itemsField:"items",totalField:"total",placeholder:"请选择产品",onChange:g},null)},{label:"级别",prop:"level_code",valueType:"select",fieldProps:{clearable:!0},renderField:(y,g)=>r(Z,{modelValue:y,uri:"/user-level",searchField:"quickSearch",labelField:"name",valueField:"code",itemsField:"items",totalField:"total",placeholder:"请选择级别",onChange:g},null)},{label:"周期",prop:"period",valueType:"select",fieldProps:{clearable:!0,placeholder:"请选择周期"},options:be}],debouncedSearch:a}},Qe=()=>{const o=h(),a=h([]);return{tableRef:o,selectedIds:a,handleSelectionChange:n=>{a.value=n.map(S=>S.id),o.value.setAdaptive()},handleSelectionCancel:()=>{var n;(n=o.value)==null||n.getTableRef().clearSelection()},tableColumns:[{label:"勾选列",type:"selection",reserveSelection:!0},{label:"ID",prop:"id",minWidth:80},{label:"产品",prop:"product.name",minWidth:100},{label:"级别",prop:"level.name",minWidth:100},{label:"周期",prop:"period",minWidth:80,formatter:({period:n})=>{var S;return(S=be.find(P=>P.value===n))==null?void 0:S.label}},{label:"价格",prop:"price",minWidth:100,formatter:({price:n})=>`¥${n}`},{label:"附加标准域名价格",prop:"alternative_standard_price",minWidth:120,formatter:({alternative_standard_price:n})=>n?`¥${n}`:"-"},{label:"附加通配符价格",prop:"alternative_wildcard_price",minWidth:120,formatter:({alternative_wildcard_price:n})=>n?`¥${n}`:"-"},{label:"创建时间",prop:"created_at",width:180,formatter:({created_at:n})=>n?Le(n).format("YYYY-MM-DD HH:mm:ss"):"-"}],handleRowClick:n=>{var S;(S=o.value)==null||S.getTableRef().toggleRowSelection(n)}}},Xe={class:"operate-form",style:"width: calc(100% - "+80/2+"px)"},Ze={class:"price"},el={class:"input"},ll={class:"price_label"},tl={class:"lable"},ol={class:"input"},al={class:"price_label"},nl={class:"lable"},rl={class:"input"},sl={class:"cost-price-wrapper"},ul={style:"width: calc(100% - "+80/1.8+"px)"},il=fe({__name:"levels",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","saved"],setup(o,{emit:a}){const p=o,y=a,g=h(0),F=h(p.modelValue),n={price:"价格",alternative_standard_price:"SAN标准域",alternative_wildcard_price:"SAN通配符"};me(()=>p.modelValue,t=>{F.value=t,t&&E.value==="base"&&Q()}),me(()=>F.value,t=>{y("update:modelValue",t)});const S=h(!1),P=h(!1),C=h(),l=U({});l.product_price=U({});const le=()=>{te(),J()},G=()=>{ae(),J()},j=U({}),d=U({}),te=()=>{!l.product_id||parseInt(l.product_id)<=0||De(l.product_id).then(t=>{t.data.periods=t.data.periods.sort((e,m)=>e-m),Object.keys(j).forEach(e=>{delete j[e]}),t.data.periods.forEach(e=>{j[e]=Oe[e]}),Object.keys(d).forEach(e=>{delete d[e]}),Object.assign(d,U(t.data.cost))})},J=()=>{if(!l.product_id||parseInt(l.product_id)<=0){l.product_price={};return}if(!l.level_codes||l.level_codes.length<=0){l.product_price={};return}Ke(l.product_id,l.level_codes).then(t=>{t.data&&(l.product_price=t.data)})},oe=h(),D=h({}),z=h({}),s=h("all"),A=Ne(()=>{const t={};return Object.keys(d).length>0&&Object.keys(d).forEach(e=>{t[e]=n[e]||e}),t}),ae=()=>{setTimeout(()=>{l.level_codes.length>0?Ee(l.level_codes).then(t=>{t.data.forEach(e=>{D.value[e.code]=e.name,z.value[e.code]=e.cost_rate})}):(D.value={},z.value={})},100)},W=U({custom:0}),E=h("base"),Q=()=>{l.level_codes=[],l.product_price={},g.value++,E.value==="base"?(W.custom=0,qe({custom:0}).then(t=>{t.data&&t.data.items&&(l.level_codes=t.data.items.map(e=>e.code),G())})):W.custom=1},R=()=>{if(!d){I("成本价不存在，无法按比例设置",{type:"warning"});return}if(!s.value){I("请选择价格类型",{type:"warning"});return}for(const e in l.product_price){if(!z.value[e]){I(D.value[e]+"成本价比例不存在",{type:"warning"});return}const m=z.value[e],b=l.product_price[e];if(s.value==="all")for(const f in b)for(const x in b[f])d[f]&&d[f][x]&&(l.product_price[e][f][x]=(parseFloat(d[f][x])*m).toFixed(2));else if(b[s.value]&&d[s.value])for(const f in b[s.value])d[s.value][f]&&(l.product_price[e][s.value][f]=(parseFloat(d[s.value][f])*m).toFixed(2))}const t=s.value==="all"?"所有类型":n[s.value]||s.value;I(`已设置${t}的级别价格`,{type:"success"})},ne=()=>{if(Object.keys(l.product_price).length===0){I("请先设置价格",{type:"warning"});return}for(const t in l.product_price){const e=l.product_price[t];for(const m in e)for(const b in e[m]){const f=parseFloat(e[m][b]);isNaN(f)||(l.product_price[t][m][b]=Math.round(f).toString())}}I("已取整到元",{type:"success"})},ie=()=>{if(Object.keys(l.product_price).length===0){I("请先设置价格",{type:"warning"});return}for(const t in l.product_price){const e=l.product_price[t];for(const m in e)for(const b in e[m]){const f=parseFloat(e[m][b]);isNaN(f)||(l.product_price[t][m][b]=(Math.round(f*10)/10).toFixed(1))}}I("已取整到角",{type:"success"})},he=(t,e,m)=>{var $;const b=t.toString(),f=e.toString(),x=m.toString(),M=parseFloat(l.product_price[b][f][x]),Y=parseFloat(($=d[f])==null?void 0:$[x]);if(!isNaN(M)&&!isNaN(Y)&&Y>0){const re=M/Y;z.value[b]=parseFloat(re.toFixed(4))}},ye=()=>{C.value&&C.value.validate().then(t=>{t&&(P.value=!0,He(parseInt(l.product_id.toString()),l.product_price).then(e=>{e.code===1&&(I("保存成功",{type:"success"}),y("saved"))}).finally(()=>{P.value=!1}))})},Ce=U({product_id:[{required:!0,message:"请选择产品",trigger:"change"}],level_codes:[{required:!0,message:"请选择会员级别",trigger:"change"}]});return(t,e)=>{const m=V("el-form-item"),b=V("el-radio"),f=V("el-radio-group"),x=V("el-input"),M=V("el-option"),Y=V("el-select"),$=V("el-button"),re=V("el-form"),ke=V("el-scrollbar"),Se=V("el-dialog"),Ve=ge("loading");return v(),L(Se,{modelValue:F.value,"onUpdate:modelValue":e[5]||(e[5]=_=>F.value=_),class:"price-levels-dialog","close-on-click-modal":!1,width:"80%",onClose:e[6]||(e[6]=_=>F.value=!1)},{header:u(()=>e[7]||(e[7]=[c("div",{class:"title"},"设置会员价格",-1)])),footer:u(()=>[c("div",ul,[r($,{onClick:e[4]||(e[4]=_=>F.value=!1)},{default:u(()=>e[20]||(e[20]=[T("关闭")])),_:1}),r($,{loading:P.value,type:"primary",onClick:ye},{default:u(()=>e[21]||(e[21]=[T(" 保存 ")])),_:1},8,["loading"])])]),default:u(()=>[ve((v(),L(ke,{class:"form-scrollbar"},{default:u(()=>[c("div",Xe,[S.value?X("",!0):(v(),L(re,{key:0,ref_key:"formRef",ref:C,model:l,"label-position":"right","label-width":"80px",rules:Ce},{default:u(()=>[r(m,{label:"产品",prop:"product_id"},{default:u(()=>[r(i(Z),{modelValue:l.product_id,"onUpdate:modelValue":e[0]||(e[0]=_=>l.product_id=_),uri:"/product","value-field":"id","label-field":"name","search-field":"quickSearch",clearable:"",placeholder:"请选择产品",pageSize:100,showPagination:!1,onChange:le},null,8,["modelValue"])]),_:1}),r(m,{label:"类型",prop:"user_level_type"},{default:u(()=>[r(f,{modelValue:E.value,"onUpdate:modelValue":e[1]||(e[1]=_=>E.value=_),onChange:Q},{default:u(()=>[r(b,{value:"base"},{default:u(()=>e[8]||(e[8]=[T("基础级别")])),_:1}),r(b,{value:"custom"},{default:u(()=>e[9]||(e[9]=[T("定制级别")])),_:1})]),_:1},8,["modelValue"])]),_:1}),r(m,{label:"会员级别"},{default:u(()=>[(v(),L(i(Z),{key:g.value,ref_key:"userLevelsRef",ref:oe,modelValue:l.level_codes,"onUpdate:modelValue":e[2]||(e[2]=_=>l.level_codes=_),queryParams:W,uri:"/user-level","value-field":"code","label-field":"name","search-field":"quickSearch",multiple:!0,"multiple-limit":10,"collapse-tags":!1,"automatic-dropdown":!0,"close-on-select":!1,clearable:"",placeholder:"请选择会员级别",onChange:G},null,8,["modelValue","queryParams"]))]),_:1}),(v(!0),w(N,null,q(l.product_price,(_,k)=>(v(),L(m,{key:k,prop:"product_price",label:D.value[k]},{default:u(()=>[c("div",null,[e[12]||(e[12]=c("div",{class:"price_label"},"成本价",-1)),c("div",Ze,[e[10]||(e[10]=c("div",{class:"lable"},"比例",-1)),c("div",el,[r(x,{modelValue:z.value[k],"onUpdate:modelValue":B=>z.value[k]=B},null,8,["modelValue","onUpdate:modelValue"])])]),e[13]||(e[13]=c("div",{class:"clear"},null,-1)),(v(!0),w(N,null,q(_,(B,O)=>(v(),w(N,{key:O},[c("div",ll,H(n[O]),1),(v(!0),w(N,null,q(Object.keys(B),K=>(v(),w("div",{key:K,class:"price"},[c("div",tl,H(j[K]),1),c("div",ol,[r(x,{modelValue:l.product_price[k][O][K],"onUpdate:modelValue":ce=>l.product_price[k][O][K]=ce,onInput:ce=>he(k,O,K)},null,8,["modelValue","onUpdate:modelValue","onInput"])])]))),128)),e[11]||(e[11]=c("div",{class:"clear"},null,-1))],64))),128)),e[14]||(e[14]=c("div",{class:"clear"},null,-1))])]),_:2},1032,["label"]))),128)),Object.keys(d).length>0?(v(),L(m,{key:0,label:"成本价"},{default:u(()=>[c("div",null,[(v(!0),w(N,null,q(d,(_,k)=>(v(),w(N,{key:k},[c("div",al,H(n[k]),1),(v(!0),w(N,null,q(Object.keys(_),B=>(v(),w("div",{key:B,class:"price"},[c("div",nl,H(j[B]),1),c("div",rl,[r(x,{modelValue:d[k][B],"onUpdate:modelValue":O=>d[k][B]=O},null,8,["modelValue","onUpdate:modelValue"])])]))),128)),e[15]||(e[15]=c("div",{class:"clear"},null,-1))],64))),128)),e[16]||(e[16]=c("div",{class:"clear"},null,-1))])]),_:1})):X("",!0),Object.keys(d).length>0?(v(),L(m,{key:1},{default:u(()=>[c("div",sl,[r(Y,{modelValue:s.value,"onUpdate:modelValue":e[3]||(e[3]=_=>s.value=_),placeholder:"选择价格类型",style:{width:"120px","margin-right":"10px"}},{default:u(()=>[r(M,{label:"全部类型",value:"all"}),(v(!0),w(N,null,q(A.value,(_,k)=>(v(),L(M,{key:k,label:_,value:k},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),r($,{type:"primary",onClick:R},{default:u(()=>e[17]||(e[17]=[T(" 按比例设置价格 ")])),_:1}),r($,{type:"info",onClick:ne},{default:u(()=>e[18]||(e[18]=[T(" 取整(元) ")])),_:1}),r($,{type:"info",onClick:ie},{default:u(()=>e[19]||(e[19]=[T(" 取整(角) ")])),_:1})])]),_:1})):X("",!0)]),_:1},8,["model","rules"]))])]),_:1})),[[Ve,S.value]])]),_:1},8,["modelValue"])}}}),cl=_e(il,[["__scopeId","data-v-973925c0"]]),dl={class:"main"},pl={class:"search bg-bg_color w-[99/100] pl-4 pr-4 pt-[24px] pb-[12px] overflow-auto"},ml={key:0,class:"bg-[var(--el-fill-color-light)] w-full h-[46px] mb-2 pl-3 pr-2 flex items-center"},fl={class:"flex-auto"},vl={style:{"font-size":"var(--el-font-size-base)"},class:"text-[rgba(42,46,54,0.5)] dark:text-[rgba(220,220,242,0.5)] ml-2"},gl=fe({name:"ProductPrice",__name:"index",setup(o){const a=h(!1),{tableRef:p,selectedIds:y,tableColumns:g,handleSelectionChange:F,handleSelectionCancel:n,handleRowClick:S}=Qe(),{loading:P,search:C,dataList:l,pagination:le,handleSizeChange:G,handleCurrentChange:j,onSearch:d,handleBatchDestroy:te}=Ge(p),{searchColumns:J,debouncedSearch:oe}=Je(()=>d());Ue(()=>{d()});function D(){p.value.setAdaptive()}return(z,s)=>{const A=V("el-button"),ae=V("el-tooltip"),W=V("el-popconfirm"),E=V("pure-table"),Q=ge("motion-fade");return v(),w("div",dl,[r(cl,{modelValue:a.value,"onUpdate:modelValue":s[0]||(s[0]=R=>a.value=R),onSaved:i(d)},null,8,["modelValue","onSaved"]),c("div",pl,[r(i(Re),{modelValue:i(C),"onUpdate:modelValue":s[1]||(s[1]=R=>je(C)?C.value=R:null),columns:i(J),"show-number":3,"row-props":{gutter:12},"col-props":{xs:24,sm:12,md:8,lg:6,xl:4},"label-width":"80","label-position":"right","label-suffix":"","has-footer":!1,onChange:i(oe)},null,8,["modelValue","columns","onChange"])]),r(i(Te),{title:"产品价格",columns:i(g),onRefresh:i(d),onFullscreen:D},{buttons:u(()=>[r(A,{type:"primary",onClick:s[2]||(s[2]=R=>a.value=!0)},{default:u(()=>s[4]||(s[4]=[T(" 设置价格 ")])),_:1})]),default:u(({size:R,dynamicColumns:ne})=>[i(y).length>0?ve((v(),w("div",ml,[c("div",fl,[r(ae,{placement:"top",content:"取消选择"},{default:u(()=>[r(A,{type:"primary",size:"small",class:"!w-[15px] !p-0 !h-[15px] !rounded-[3px]",icon:i(Ae)(i(We)),onClick:i(n)},null,8,["icon","onClick"])]),_:1}),c("span",vl," 已选 "+H(i(y).length)+" 项 ",1)]),r(W,{title:"确定要删除吗？",width:"160px",onConfirm:s[3]||(s[3]=ie=>i(te)(i(y)))},{reference:u(()=>[r(A,{type:"danger",size:"small"},{default:u(()=>s[5]||(s[5]=[T(" 批量删除 ")])),_:1})]),_:1})])),[[Q]]):X("",!0),r(E,{ref_key:"tableRef",ref:p,"row-key":"id","align-whole":"left","table-layout":"auto",loading:i(P),size:R,adaptive:"",adaptiveConfig:{offsetBottom:108},data:i(l),columns:ne,pagination:ue(se({},i(le)),{size:R}),"header-cell-style":{background:"var(--el-fill-color-light)",color:"var(--el-text-color-primary)"},onRowClick:i(S),onSelectionChange:i(F),onPageSizeChange:i(G),onPageCurrentChange:i(j)},null,8,["loading","size","data","columns","pagination","onRowClick","onSelectionChange","onPageSizeChange","onPageCurrentChange"])]),_:1},8,["columns","onRefresh"])])}}}),xl=_e(gl,[["__scopeId","data-v-dc927aac"]]);export{xl as default};
