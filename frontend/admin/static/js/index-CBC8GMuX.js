var oe=Object.defineProperty,ne=Object.defineProperties;var re=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var se=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var $=(e,t,a)=>t in e?oe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,R=(e,t)=>{for(var a in t||(t={}))se.call(t,a)&&$(e,a,t[a]);if(E)for(var a of E(t))ie.call(t,a)&&$(e,a,t[a]);return e},z=(e,t)=>ne(e,re(t));import{P as ue,a as ce}from"./plus-search-9LL5vjUH.js";import{k as S,r as f,l as de,m as O,t as me,n as pe,p as fe,d as j,f as s,h as C,bc as he,A as k,ao as ge,q as ve,eh as be,aH as ye,I as Ce,s as M,o as _e,c as W,e as Y,v as A,i as o,j as U,w as h,x as ke,y as Se,z as Ie,B as we,_ as xe}from"./index-B8e-qeTz.js";import{_ as Ve}from"./index.vue_vue_type_script_setup_true_lang-Bnvnxcm1.js";import{p as Pe}from"./utils-Dnh5kgzw.js";import{i as Te}from"./dictionary-DQGdH2_d.js";import{i as N}from"./isIP-kGEcB3i6.js";import{u as Re}from"./hooks-Dxk504sx.js";import{u as ze}from"./drawer-BxEc30gF.js";import{C as Ae}from"./close-bold-C6b3L9K4.js";import{P as Fe}from"./index-DBY8o_2r.js";import"./index-C0oCruPR.js";import"./epTheme-CJfp4t94.js";function De(e){return S.get("/api-token",{params:e})}const H={user_id:0,token:"",allowed_ips:[],rate_limit:100,status:1},Be=Object.keys(H);function Ee(e){return S.post("/api-token",{data:e})}function $e(e,t){return S.put(`/api-token/${e}`,{data:t})}function Oe(e){return S.get(`/api-token/${e}`)}function Me(e){return S.delete(`/api-token/${e}`)}function We(e){return S.delete("/api-token/batch",{data:{ids:e}})}function Ye(e){const t=f({}),a=f([]),u=f(!0),c=de({total:0,pageSize:10,currentPage:1,background:!0,pageSizes:[10,20,50,100]});function _(n){c.pageSize=n,l()}function r(n){c.currentPage=n,l()}const g=n=>{Me(n).then(()=>{O("删除成功",{type:"success"}),l()})},b=n=>{We(n).then(()=>{O("删除成功",{type:"success"}),l()})};function l(){u.value=!0;const n=z(R({},me(t.value)),{pageSize:c.pageSize,currentPage:c.currentPage});De(n).then(({data:p})=>{a.value=p.items,c.total=p.total,c.pageSize=p.pageSize,c.currentPage=p.currentPage,pe(()=>{e.value&&e.value.getTableRef().clearSelection()})}).finally(()=>{u.value=!1})}return{loading:u,search:t,dataList:a,pagination:c,handleSizeChange:_,handleCurrentChange:r,onSearch:l,handleDestroy:g,handleBatchDestroy:b}}const Ue=e=>{const t=fe(()=>{e()},500);return{searchColumns:[{label:"用户名",prop:"username",valueType:"input",fieldProps:{placeholder:"请输入用户名"}},{label:"状态",prop:"status",valueType:"select",options:[{label:"启用",value:1},{label:"禁用",value:0}],fieldProps:{placeholder:"请选择状态"}}],debouncedSearch:t}},Ne=j({name:"IpArrayInput",props:{modelValue:{type:Array,default:()=>[]},maxItems:{type:Number,default:10}},emits:["update:modelValue"],setup(e,{emit:t}){const a=f(Array(e.modelValue.length).fill("")),u=(l,n)=>l?!N(l,4)&&!N(l,6)?(a.value[n]="请输入有效的IP地址",!1):(a.value[n]="",!0):(a.value[n]="IP地址不能为空",!1);return{ipErrors:a,addItem:()=>{const l=[...e.modelValue,""];a.value.push(""),t("update:modelValue",l)},removeItem:l=>{const n=[...e.modelValue];n.splice(l,1),a.value.splice(l,1),t("update:modelValue",n)},updateItem:(l,n)=>{const p=[...e.modelValue];p[l]=n,t("update:modelValue",p)},validateOnBlur:l=>{u(e.modelValue[l],l)},validate:()=>{if(e.modelValue.length>e.maxItems)return{valid:!1,message:`IP白名单不能超过${e.maxItems}个`};for(let l=0;l<e.modelValue.length;l++)if(!u(e.modelValue[l],l))return{valid:!1,message:a.value[l]};return{valid:!0}}}},render(){return s("div",null,[this.modelValue.map((e,t)=>s("div",{class:"flex flex-col mb-2",key:t},[s("div",{class:"flex items-center"},[s(C("el-input"),{modelValue:e,placeholder:`IP地址 ${t+1}`,"onUpdate:modelValue":a=>this.updateItem(t,a),onBlur:()=>this.validateOnBlur(t),status:this.ipErrors[t]?"error":""},null),s(C("el-button"),{type:"danger",size:"small",plain:!0,class:"ml-2",onClick:()=>this.removeItem(t)},{default:()=>[s(C("el-icon"),null,{default:()=>[s(he,null,null)]})]})]),this.ipErrors[t]&&s("div",{class:"text-red-500 text-xs mt-1"},[this.ipErrors[t]])])),s(C("el-button"),{type:"primary",size:"small",plain:!0,class:"mt-2",onClick:this.addItem},{default:()=>[k("添加IP")]}),this.modelValue.length>this.maxItems&&s("div",{class:"text-red-500 text-xs mt-1"},[k("IP白名单不能超过"),this.maxItems,k("个")])])}}),je=e=>{const t=f(!1),a=f(),u=f(0),c=f({}),_=f(),r=[{label:"用户",prop:"user_id",valueType:"select",renderField:(i,m)=>s(Ve,{modelValue:i,uri:"/user",searchField:"quickSearch",labelField:"username",valueField:"id",itemsField:"items",totalField:"total",placeholder:"请选择用户",onChange:m,refreshKey:u.value},null)},{label:"Token",prop:"token",valueType:"input",hideInForm:ve(()=>u.value>0),fieldProps:{placeholder:"请输入Token"},fieldSlots:{append:()=>ge(ye,{onClick:()=>{c.value.token=be(64)}},()=>"生成")}},{label:"IP白名单",prop:"allowed_ips",renderField:(i,m)=>{const y=Array.isArray(i)?i:i?[i]:[];return s(Ne,{ref:_,modelValue:y,"onUpdate:modelValue":m,maxItems:10},null)}},{label:"频率限制",prop:"rate_limit",valueType:"input-number",fieldProps:{placeholder:"请输入频率限制/分钟",min:1,max:1e4}},{label:"状态",prop:"status",valueType:"switch",fieldProps:Te}],g={user_id:[{required:!0,message:"请选择用户"}],token:[{max:128,message:"Token长度不能超过128个字符"}],rate_limit:[{type:"number",min:1,message:"频率限制必须大于0"}],status:[{required:!0,message:"请选择状态"}]};function b(i=0){var m,y;t.value=!0,i>0?u.value!==i&&p(i):((y=(m=a.value)==null?void 0:m.formInstance)==null||y.resetFields(),c.value=Object.fromEntries(Object.entries(H).filter(([F,w])=>w!==0&&w!==""))),u.value=i}function l(){var i,m;(m=(i=a.value)==null?void 0:i.formInstance)==null||m.validate(y=>{y&&(u.value>0?V():x())})}function n(){t.value=!1}const p=i=>{Oe(i).then(m=>{c.value=Pe(m.data,Be)})},x=()=>{Ee(c.value).then(()=>{e(),t.value=!1})},V=()=>{$e(u.value,c.value).then(()=>{e(),t.value=!1})};return{storeRef:a,showStore:t,storeId:u,storeValues:c,storeColumns:r,rules:g,openStoreForm:b,confirmStoreForm:l,closeStoreForm:n}},He=()=>{const e=f(),t=f([]),a=r=>{t.value=r.map(g=>g.id),e.value.setAdaptive()},u=()=>{var r;(r=e.value)==null||r.getTableRef().clearSelection()},c=[{label:"勾选列",type:"selection",reserveSelection:!0},{label:"ID",prop:"id",minWidth:80},{label:"用户名",prop:"user.username",minWidth:120,cellRenderer:Ce("user.username")},{label:"IP白名单",prop:"allowed_ips",minWidth:200},{label:"频率限制",prop:"rate_limit",minWidth:100,formatter:({rate_limit:r})=>`${r}/分钟`},{label:"最后调用时间",prop:"last_used_at",minWidth:100,formatter:({last_used_at:r})=>r?M(r).format("YYYY-MM-DD HH:mm:ss"):"从未调用"},{label:"最后调用IP",prop:"last_used_ip",minWidth:100,formatter:({last_used_ip:r})=>r||"从未调用"},{label:"状态",prop:"status",minWidth:80,formatter:({status:r})=>r===1?"启用":"禁用"},{label:"创建时间",prop:"created_at",minWidth:180,formatter:({created_at:r})=>r?M(r).format("YYYY-MM-DD HH:mm:ss"):"-"},{label:"操作",fixed:"right",slot:"operation",width:110}];return{tableRef:e,selectedIds:t,handleSelectionChange:a,handleSelectionCancel:u,tableColumns:c,handleRowClick:(r,g,b)=>{var n;const l=b.target;l.tagName==="BUTTON"||l.closest("button")||l.closest(".el-button")||(n=e.value)==null||n.getTableRef().toggleRowSelection(r)}}},qe={class:"main"},Ke={class:"search bg-bg_color w-[99/100] pl-4 pr-4 pt-[24px] pb-[12px] overflow-auto"},Le={key:0,class:"bg-[var(--el-fill-color-light)] w-full h-[46px] mb-2 pl-3 pr-2 flex items-center"},Ge={class:"flex-auto"},Je={style:{"font-size":"var(--el-font-size-base)"},class:"text-[rgba(42,46,54,0.5)] dark:text-[rgba(220,220,242,0.5)] ml-2"},Qe=j({name:"ApiToken",__name:"index",setup(e){const{drawerSize:t}=ze(),{tableRef:a,selectedIds:u,handleSelectionChange:c,handleSelectionCancel:_,tableColumns:r,handleRowClick:g}=He(),{loading:b,search:l,dataList:n,pagination:p,handleSizeChange:x,handleCurrentChange:V,onSearch:i,handleDestroy:m,handleBatchDestroy:y}=Ye(a),{searchColumns:F,debouncedSearch:w}=Ue(()=>i()),{storeRef:q,showStore:K,storeId:L,storeColumns:G,rules:J,storeValues:P,openStoreForm:D,confirmStoreForm:Q,closeStoreForm:X}=je(()=>i());return _e(()=>{i()}),(Xe,d)=>{const I=C("el-button"),Z=C("el-tooltip"),B=C("el-popconfirm"),ee=C("pure-table"),te=we("motion-fade");return Y(),W("div",qe,[A("div",Ke,[s(o(ue),{modelValue:o(l),"onUpdate:modelValue":d[0]||(d[0]=v=>U(l)?l.value=v:null),columns:o(F),"show-number":2,"row-props":{gutter:12},"col-props":{xs:24,sm:12,md:8,lg:6,xl:4},"label-width":"80","label-position":"right","label-suffix":"","has-footer":!1,onChange:o(w)},null,8,["modelValue","columns","onChange"])]),s(o(ce),{title:"Token管理",columns:o(r),onRefresh:o(i)},{buttons:h(()=>[s(I,{type:"primary",onClick:d[1]||(d[1]=v=>o(D)())},{default:h(()=>d[4]||(d[4]=[k(" 新增Token ")])),_:1})]),default:h(({size:v,dynamicColumns:le})=>[o(u).length>0?ke((Y(),W("div",Le,[A("div",Ge,[s(Z,{placement:"top",content:"取消选择"},{default:h(()=>[s(I,{type:"primary",size:"small",class:"!w-[15px] !p-0 !h-[15px] !rounded-[3px]",icon:o(Re)(o(Ae)),onClick:o(_)},null,8,["icon","onClick"])]),_:1}),A("span",Je," 已选 "+Ie(o(u).length)+" 项 ",1)]),s(B,{title:"确定要删除吗？",width:"160px",onConfirm:d[2]||(d[2]=T=>o(y)(o(u)))},{reference:h(()=>[s(I,{type:"danger",size:"small"},{default:h(()=>d[5]||(d[5]=[k(" 批量删除 ")])),_:1})]),_:1})])),[[te]]):Se("",!0),s(ee,{ref_key:"tableRef",ref:a,"row-key":"id","align-whole":"left","table-layout":"auto",loading:o(b),size:v,adaptive:"",adaptiveConfig:{offsetBottom:108},data:o(n),columns:le,pagination:z(R({},o(p)),{size:v}),"header-cell-style":{background:"var(--el-fill-color-light)",color:"var(--el-text-color-primary)"},onRowClick:o(g),onSelectionChange:o(c),onPageSizeChange:o(x),onPageCurrentChange:o(V)},{operation:h(({row:T})=>[s(I,{class:"reset-margin !outline-none",type:"primary",link:"",size:v,onClick:ae=>o(D)(T.id)},{default:h(()=>d[6]||(d[6]=[k(" 编辑 ")])),_:2},1032,["size","onClick"]),s(B,{title:"确定要删除吗？",width:"160px",onConfirm:ae=>o(m)(T.id)},{reference:h(()=>[s(I,{class:"reset-margin !outline-none",link:"",type:"danger",size:v},{default:h(()=>d[7]||(d[7]=[k(" 删除 ")])),_:2},1032,["size"])]),_:2},1032,["onConfirm"])]),_:2},1032,["loading","size","data","columns","pagination","onRowClick","onSelectionChange","onPageSizeChange","onPageCurrentChange"])]),_:1},8,["columns","onRefresh"]),s(o(Fe),{ref_key:"storeRef",ref:q,modelValue:o(P),"onUpdate:modelValue":d[3]||(d[3]=v=>U(P)?P.value=v:null),visible:o(K),form:{columns:o(G),rules:o(J),labelPosition:"right",labelSuffix:"",labelWidth:100},size:o(t),closeOnClickModal:!0,title:o(L)>0?"编辑Token":"新增Token",confirmText:"提交",cancelText:"取消",onConfirm:o(Q),onCancel:o(X)},null,8,["modelValue","visible","form","size","title","onConfirm","onCancel"])])}}}),mt=xe(Qe,[["__scopeId","data-v-91c11f7f"]]);export{mt as default};
