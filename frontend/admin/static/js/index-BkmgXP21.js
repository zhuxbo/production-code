var ke=Object.defineProperty,Fe=Object.defineProperties;var xe=Object.getOwnPropertyDescriptors;var ue=Object.getOwnPropertySymbols;var Re=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable;var de=(s,i,u)=>i in s?ke(s,i,{enumerable:!0,configurable:!0,writable:!0,value:u}):s[i]=u,ee=(s,i)=>{for(var u in i||(i={}))Re.call(i,u)&&de(s,u,i[u]);if(ue)for(var u of ue(i))Se.call(i,u)&&de(s,u,i[u]);return s},le=(s,i)=>Fe(s,xe(i));var te=(s,i,u)=>new Promise((n,t)=>{var c=v=>{try{V(u.next(v))}catch(h){t(h)}},f=v=>{try{V(u.throw(v))}catch(h){t(h)}},V=v=>v.done?n(v.value):Promise.resolve(v.value).then(c,f);V((u=u.apply(s,i)).next())});import{K as se,r as F,l as ne,Q as oe,t as De,p as Pe,j as r,f as x,v as ce,D as C,bd as we,q as W,F as Q,e as Te,o as ze,g as D,i as b,y as g,u as e,k as q,w as m,P as Ne,A as ae,C as T,H,I,G as P,_ as Oe}from"./index-2C-ofHV5.js";import{_ as pe}from"./index.vue_vue_type_script_setup_true_lang-BHKqx4-E.js";import{c as Ue}from"./utils-C-gUDCcE.js";import{P as Me}from"./plus-search-B1FvdIYy.js";import{g as Ye}from"./datePicker-ZEs-rmon.js";import{a as Ee}from"./admin-5Hajs9G6.js";import{i as $e}from"./notificationTemplate-BVb_ANBk.js";import"./index-CaJyLCRQ.js";function je(s){return se.get("/notification",{params:s})}function Be(s,i){return se.post(`/notification/${s}/resend`,{data:i})}function We(s){return se.post("/notification/test-send",{data:s})}function qe(){const s=F({template_code:"",status:"",user_id:null,created_at:[null,null]}),i=F([]),u=F(!0),n=ne({total:0,pageSize:10,currentPage:1,background:!0,pageSizes:[10,20,50,100]}),t=F(!1),c=F(null),f=F(!1),V=F([]),v=F(null);function h(p){n.pageSize=p,S()}function z(p){n.currentPage=p,S()}function S(){u.value=!0;const p=le(ee({},De(s.value)),{pageSize:n.pageSize,currentPage:n.currentPage});p.user_id&&(p.user_id=Number(p.user_id)),p.created_at&&p.created_at[0]&&p.created_at[1]?p.created_at=Ue(p.created_at):delete p.created_at,je(p).then(({data:o})=>{i.value=o.items,n.total=o.total,n.pageSize=o.pageSize,n.currentPage=o.currentPage}).finally(()=>{u.value=!1})}return{loading:u,search:s,dataList:i,pagination:n,handleSizeChange:h,handleCurrentChange:z,onSearch:S,onReset:()=>{s.value.template_code="",s.value.status="",s.value.user_id=null,s.value.created_at=[null,null],n.currentPage=1,S()},onCollapse:()=>{setTimeout(()=>{window.dispatchEvent(new Event("resize"))},500)},detailDialogVisible:t,detailRecord:c,openDetail:p=>{c.value=p,t.value=!0},showPayload:p=>JSON.stringify(p!=null?p:{},null,2),resendDialogVisible:f,resendChannels:V,resendTarget:v,openResend:p=>{v.value=p,V.value=[],f.value=!0},confirmResend:()=>{v.value&&Be(v.value.id,{channels:V.value.length?V.value:void 0}).then(()=>{oe.success("已提交重发任务"),f.value=!1,S()})},closeResend:()=>{f.value=!1}}}const He=[{label:"全部",value:""},{label:"待发送",value:"pending"},{label:"发送中",value:"sending"},{label:"已发送",value:"sent"},{label:"失败",value:"failed"}];function Ie(s){const i=Pe(()=>{s()},500);return{searchColumns:[{label:"用户",prop:"user_id",valueType:"select",renderField:(n,t)=>r(pe,{modelValue:n,uri:"/user",searchField:"quickSearch",labelField:"username",valueField:"id",itemsField:"items",totalField:"total",placeholder:"搜索用户名/邮箱",clearable:!0,onChange:c=>{t(c),i()}},null)},{label:"模板标识",prop:"template_code",valueType:"input",fieldProps:{placeholder:"cert_issued",clearable:!0},onChange:()=>{i()}},{label:"状态",prop:"status",valueType:"select",options:He,fieldProps:{placeholder:"请选择状态"},onChange:()=>{i()}},{label:"创建时间",prop:"created_at",valueType:"date-picker",fieldProps:{type:"daterange",shortcuts:Ye(),rangeSeparator:"至",startPlaceholder:"开始日期",endPlaceholder:"结束日期",valueFormat:"YYYY-MM-DD"}}]}}function Le(){const s=F(),i={pending:{label:"待发送",type:"info"},sending:{label:"发送中",type:"warning"},sent:{label:"已发送",type:"success"},failed:{label:"失败",type:"danger"}};return{tableRef:s,tableColumns:[{label:"ID",prop:"id",minWidth:90},{label:"模板",prop:"template",minWidth:220,cellRenderer:({row:n})=>{var t,c;return r("div",{class:"flex flex-col"},[r("span",null,[((t=n.template)==null?void 0:t.name)||"-"]),r("small",{class:"text-muted"},[(c=n.template)==null?void 0:c.code])])}},{label:"用户信息",prop:"user",minWidth:220,cellRenderer:({row:n})=>{var t,c;return r("div",{class:"flex flex-col"},[r("span",null,[((t=n.notifiable)==null?void 0:t.username)||n.notifiable_id]),r("small",{class:"text-muted"},[((c=n.notifiable)==null?void 0:c.email)||"-"])])}},{label:"状态",prop:"status",width:120,cellRenderer:({row:n,props:t})=>{var c;return r(x("el-tag"),{size:t.size,type:(c=i[n.status])==null?void 0:c.type,effect:"plain"},{default:()=>{var f;return[((f=i[n.status])==null?void 0:f.label)||n.status]}})}},{label:"创建时间",prop:"created_at",minWidth:160,formatter:({created_at:n})=>n?ce(n).format("YYYY-MM-DD HH:mm:ss"):"-"},{label:"发送时间",prop:"sent_at",minWidth:160,formatter:({sent_at:n})=>n?ce(n).format("YYYY-MM-DD HH:mm:ss"):"-"},{label:"通道结果",prop:"channel_results",minWidth:220,cellRenderer:({row:n})=>{var t;return(t=n.data)!=null&&t.channel_results?r("div",null,[Object.entries(n.data.channel_results).map(([c,f])=>r(x("el-tag"),{key:c,size:"small",type:f.status==="sent"?"success":"danger",class:"mr-1 mb-1"},{default:()=>[c,C(" "),f.status]}))]):r("span",{class:"text-muted"},[C("-")])}},{label:"操作",prop:"operation",width:140,fixed:"right",slot:"operation"}]}}const Ae=["mail","sms"],Ge=["pem","cert","key","ca","list_html","list_plain","result_data","error_message","content"],Je=s=>s.includes("html")||Ge.includes(s),X=[{label:"用户",value:"user",remote:{uri:"/user",searchField:"quickSearch",labelField:"username",valueField:"id",itemsField:"items",totalField:"total"},fetchDetail:we},{label:"管理员",value:"admin",remote:{uri:"/admin",searchField:"quickSearch",labelField:"username",valueField:"id",itemsField:"items",totalField:"total"},fetchDetail:Ee}];function Ke(s){var j,p;const i=F(!1),u=F([]),n=F(!1),t=ne({notifiable_type:(p=(j=X[0])==null?void 0:j.value)!=null?p:"user",notifiable_id:null,template_type:"",channel:""}),c=ne({}),f=F(null),V=W(()=>{var o;return(o=X.find(d=>d.value===t.notifiable_type))!=null?o:X[0]}),v=W(()=>Array.from(new Map(u.value.map(o=>[o.code,o])).values())),h=W(()=>{var o;return!t.template_type||!t.channel?null:(o=u.value.find(d=>{var _;return d.code===t.template_type&&((_=d.channels)==null?void 0:_.includes(t.channel))}))!=null?o:null}),z=W(()=>{var o,d;return(d=(o=h.value)==null?void 0:o.variables)!=null?d:[]}),S=W(()=>{if(!t.template_type)return[];const o=u.value.filter(_=>_.code===t.template_type),d=new Set;return o.forEach(_=>{var k;(k=_.channels)==null||k.forEach(E=>d.add(E))}),Array.from(d)}),U=()=>te(null,null,function*(){var o;if(!u.value.length){n.value=!0;try{const{data:d}=yield $e({currentPage:1,pageSize:200,status:1});u.value=(o=d.items)!=null?o:[]}finally{n.value=!1}}}),y=()=>{Object.keys(c).forEach(o=>delete c[o]),z.value.forEach(o=>{c[o]=""}),$()},$=()=>{if(!f.value)return;const o=["created_at","executed_at","updated_at","deleted_at","read_at","sent_at"];z.value.forEach(d=>{var E;if(o.includes(d))return;const _=c[d],k=(E=f.value)==null?void 0:E[d];(_==null||_==="")&&k!==void 0&&typeof k!="object"&&(c[d]=k!=null?k:"")})},L=()=>{t.notifiable_id=null,t.template_type="",t.channel="",f.value=null,y(),i.value=!0,U()},M=()=>{if(!t.notifiable_id||!t.template_type||!t.channel){oe.warning("请选择通知对象、模板和通道");return}const o=Object.fromEntries(Object.entries(c).filter(([,d])=>d!==""&&d!==null&&d!==void 0));We({notifiable_type:t.notifiable_type,notifiable_id:Number(t.notifiable_id),template_type:t.template_type,channels:[t.channel],data:Object.keys(o).length?o:void 0}).then(()=>{oe.success("测试通知已提交"),i.value=!1,s()})},Y=()=>{i.value=!1};return Q(()=>t.template_type,(o,d)=>{o!==d&&(t.channel=""),y()}),Q(()=>t.channel,()=>{y()}),Q(()=>t.notifiable_type,()=>{t.notifiable_id=null,f.value=null,y()}),Q(()=>t.notifiable_id,o=>te(null,null,function*(){var _;const d=V.value;if(!d||!o||!d.fetchDetail){f.value=null;return}try{const k=yield d.fetchDetail(Number(o));f.value=(_=k.data)!=null?_:null,$()}catch(k){f.value=null}})),{testDialogVisible:i,templateOptions:v,templateLoading:n,testForm:t,testPayload:c,selectedNotifiable:f,currentNotifiableOption:V,selectedTemplate:h,templateVariables:z,availableChannelsForTemplate:S,openTestDialog:L,confirmTestSend:M,closeTestDialog:Y,isMultilineField:Je}}const Qe={class:"main"},Xe={class:"search bg-bg_color w-[99/100] pl-4 pr-4 pt-[24px] pb-[12px] overflow-auto"},Ze={key:0,class:"detail-block"},el={key:0},ll={class:"flex flex-col gap-2 w-full"},tl={class:"flex flex-col"},al={class:"text-muted"},nl={key:1,class:"flex flex-col gap-2"},ol=Te({name:"NotificationRecords",__name:"index",setup(s){const{tableRef:i,tableColumns:u}=Le(),{loading:n,search:t,dataList:c,pagination:f,handleSizeChange:V,handleCurrentChange:v,onSearch:h,onReset:z,onCollapse:S,detailDialogVisible:U,detailRecord:y,openDetail:$,showPayload:L,resendDialogVisible:M,resendChannels:Y,openResend:j,confirmResend:p,closeResend:o}=qe(),{searchColumns:d}=Ie(()=>h()),{testDialogVisible:_,templateOptions:k,templateLoading:E,testForm:R,testPayload:A,currentNotifiableOption:N,templateVariables:ie,availableChannelsForTemplate:me,openTestDialog:fe,confirmTestSend:be,closeTestDialog:_e,isMultilineField:ve}=Ke(()=>h());return ze(()=>{h()}),(sl,a)=>{const O=x("el-button"),ge=x("pure-table"),Z=x("el-dialog"),G=x("el-option"),J=x("el-select"),K=x("el-form-item"),he=x("el-divider"),ye=x("el-alert"),re=x("el-input"),Ce=x("el-form");return b(),D("div",Qe,[g("div",Xe,[r(e(Me),{modelValue:e(t),"onUpdate:modelValue":a[0]||(a[0]=l=>q(t)?t.value=l:null),columns:e(d),"show-number":4,"label-width":"90","label-position":"right","label-suffix":"","has-footer":!1,onSearch:e(h),onReset:e(z),onCollapse:e(S)},null,8,["modelValue","columns","onSearch","onReset","onCollapse"])]),r(e(Ne),{title:"通知记录",columns:e(u),onRefresh:e(h)},{buttons:m(()=>[r(O,{type:"primary",onClick:e(fe)},{default:m(()=>[...a[9]||(a[9]=[C("测试通知",-1)])]),_:1},8,["onClick"])]),default:m(({size:l,dynamicColumns:w})=>[r(ge,{ref_key:"tableRef",ref:i,"row-key":"id","align-whole":"left","table-layout":"auto",loading:e(n),size:l,adaptive:"",adaptiveConfig:{offsetBottom:108},data:e(c),columns:w,pagination:le(ee({},e(f)),{size:l}),"header-cell-style":{background:"var(--el-fill-color-light)",color:"var(--el-text-color-primary)"},onPageSizeChange:e(V),onPageCurrentChange:e(v)},{operation:m(({row:B})=>[r(O,{class:"reset-margin !outline-none",type:"primary",link:"",size:l,onClick:Ve=>e($)(B)},{default:m(()=>[...a[10]||(a[10]=[C(" 查看详情 ",-1)])]),_:1},8,["size","onClick"]),r(O,{class:"reset-margin !outline-none",type:"success",link:"",size:l,onClick:Ve=>e(j)(B)},{default:m(()=>[...a[11]||(a[11]=[C(" 重发 ",-1)])]),_:1},8,["size","onClick"])]),_:2},1032,["loading","size","data","columns","pagination","onPageSizeChange","onPageCurrentChange"])]),_:1},8,["columns","onRefresh"]),r(Z,{modelValue:e(U),"onUpdate:modelValue":a[1]||(a[1]=l=>q(U)?U.value=l:null),width:"640px",title:"通知详情","destroy-on-close":""},{default:m(()=>{var l,w,B;return[e(y)?(b(),D("div",Ze,[g("p",null,[a[12]||(a[12]=g("strong",null,"ID：",-1)),C(T(e(y).id),1)]),g("p",null,[a[13]||(a[13]=g("strong",null,"模板：",-1)),C(T((l=e(y).template)==null?void 0:l.name)+" ("+T((w=e(y).template)==null?void 0:w.code)+") ",1)]),g("p",null,[a[14]||(a[14]=g("strong",null,"用户：",-1)),C(T((B=e(y).notifiable)==null?void 0:B.username),1)]),e(y).sent_at?(b(),D("p",el,[a[15]||(a[15]=g("strong",null,"发送时间：",-1)),C(T(e(y).sent_at),1)])):ae("",!0),g("div",null,[a[16]||(a[16]=g("strong",null,"数据：",-1)),g("pre",null,T(e(L)(e(y).data)),1)])])):ae("",!0)]}),_:1},8,["modelValue"]),r(Z,{modelValue:e(M),"onUpdate:modelValue":a[3]||(a[3]=l=>q(M)?M.value=l:null),title:"选择重发通道",width:"420px","destroy-on-close":""},{footer:m(()=>[r(O,{onClick:e(o)},{default:m(()=>[...a[17]||(a[17]=[C("取消",-1)])]),_:1},8,["onClick"]),r(O,{type:"primary",onClick:e(p)},{default:m(()=>[...a[18]||(a[18]=[C("确定",-1)])]),_:1},8,["onClick"])]),default:m(()=>[r(J,{modelValue:e(Y),"onUpdate:modelValue":a[2]||(a[2]=l=>q(Y)?Y.value=l:null),multiple:"",placeholder:"不选择则使用用户默认配置"},{default:m(()=>[(b(!0),D(H,null,I(e(Ae),l=>(b(),P(G,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue"]),r(Z,{modelValue:e(_),"onUpdate:modelValue":a[8]||(a[8]=l=>q(_)?_.value=l:null),title:"测试发送通知",width:"640px","destroy-on-close":""},{footer:m(()=>[r(O,{onClick:e(_e)},{default:m(()=>[...a[20]||(a[20]=[C("取消",-1)])]),_:1},8,["onClick"]),r(O,{type:"primary",onClick:e(be)},{default:m(()=>[...a[21]||(a[21]=[C("提交",-1)])]),_:1},8,["onClick"])]),default:m(()=>[r(Ce,{"label-width":"110px"},{default:m(()=>[r(K,{label:"通知对象"},{default:m(()=>[g("div",ll,[r(J,{modelValue:e(R).notifiable_type,"onUpdate:modelValue":a[4]||(a[4]=l=>e(R).notifiable_type=l),placeholder:"请选择对象类型"},{default:m(()=>[(b(!0),D(H,null,I(e(X),l=>(b(),P(G,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e(N)?(b(),P(e(pe),{key:e(R).notifiable_type,modelValue:e(R).notifiable_id,"onUpdate:modelValue":a[5]||(a[5]=l=>e(R).notifiable_id=l),uri:e(N).remote.uri,searchField:e(N).remote.searchField,labelField:e(N).remote.labelField,valueField:e(N).remote.valueField,itemsField:e(N).remote.itemsField,totalField:e(N).remote.totalField,clearable:"",placeholder:"请选择通知接收者"},null,8,["modelValue","uri","searchField","labelField","valueField","itemsField","totalField"])):ae("",!0)])]),_:1}),r(K,{label:"模板"},{default:m(()=>[r(J,{modelValue:e(R).template_type,"onUpdate:modelValue":a[6]||(a[6]=l=>e(R).template_type=l),filterable:"",placeholder:"请选择模板",loading:e(E)},{default:m(()=>[(b(!0),D(H,null,I(e(k),l=>(b(),P(G,{key:l.id,label:l.name,value:l.code},{default:m(()=>[g("div",tl,[g("span",null,T(l.name),1),g("small",al,T(l.code),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),r(K,{label:"通道",required:""},{default:m(()=>[r(J,{modelValue:e(R).channel,"onUpdate:modelValue":a[7]||(a[7]=l=>e(R).channel=l),clearable:"",placeholder:"请选择发送通道（必选）",disabled:!e(R).template_type},{default:m(()=>[(b(!0),D(H,null,I(e(me),l=>(b(),P(G,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),r(he,{"content-position":"left"},{default:m(()=>[...a[19]||(a[19]=[C("模板变量",-1)])]),_:1}),e(ie).length?(b(),D("div",nl,[(b(!0),D(H,null,I(e(ie),l=>(b(),P(K,{key:l,label:l},{default:m(()=>[e(ve)(l)?(b(),P(re,{key:1,modelValue:e(A)[l],"onUpdate:modelValue":w=>e(A)[l]=w,type:"textarea",rows:3,placeholder:`请输入 ${l}`},null,8,["modelValue","onUpdate:modelValue","placeholder"])):(b(),P(re,{key:0,modelValue:e(A)[l],"onUpdate:modelValue":w=>e(A)[l]=w,clearable:"",placeholder:`请输入 ${l}`},null,8,["modelValue","onUpdate:modelValue","placeholder"]))]),_:2},1032,["label"]))),128))])):(b(),P(ye,{key:0,type:"info",closable:!1,description:"请选择模板和通道后填写所需的变量。未填写的变量将在发送时留空。",class:"mb-4"}))]),_:1})]),_:1},8,["modelValue"])])}}}),_l=Oe(ol,[["__scopeId","data-v-348ad0e7"]]);export{_l as default};
