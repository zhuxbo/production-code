import{_ as te}from"./index.vue_vue_type_script_setup_true_lang-B9my04-j.js";import{s as _e}from"./product-CbpaFXC-.js";import{k as D,d as ge,r as m,D as M,l as P,q as be,E as I,e as n,w as s,h as _,x as ye,B as Ve,v as a,y as G,f as c,c as g,i as le,A as S,G as L,F as h,z as E,m as y,_ as ke}from"./index-2hNLZh7L.js";import{b as Ie,i as he}from"./userLevel-B8fD8lwk.js";import{a as Ne}from"./dictionary-DFfC0KQQ.js";function ze(b){return D.get("/product-price",{params:b})}function Me(b){return D.delete("/product-price/batch",{data:{ids:b}})}function we(b,F){return D.get("/product-price/get",{params:{product_id:b,level_codes:F}})}function Ce(b,F){return D.put("/product-price/set",{data:{product_id:b,product_price:F}})}const Pe={class:"operate-form",style:"width: calc(100% - "+80/2+"px)"},Se={class:"price"},Le={class:"input"},Fe={class:"price_label"},Te={class:"lable"},Ue={class:"input"},je={class:"price_label"},Oe={class:"lable"},xe={class:"input"},qe={class:"cost-price-wrapper"},Be={style:"width: calc(100% - "+80/1.8+"px)"},Ee=ge({__name:"levels",props:{modelValue:{type:Boolean,default:!1},productId:{type:[Number,null],default:null}},emits:["update:modelValue","saved"],setup(b,{emit:F}){const R=b,J=F,Y=m(0),N=m(R.modelValue),x={price:"价格",alternative_standard_price:"SAN标准域",alternative_wildcard_price:"SAN通配符"};M(()=>R.modelValue,l=>{N.value=l,l&&B.value==="base"&&Z()}),M(()=>N.value,l=>{J("update:modelValue",l)}),M(()=>[R.productId,N.value],([l,e])=>{e&&l&&Number(l)>0&&(!t.product_id||Number(t.product_id)!==Number(l))&&(t.product_id=Number(l),Q())},{immediate:!0});const H=m(!1),$=m(!1),A=m(),t=P({});t.product_price=P({});const Q=()=>{oe(),X()},W=()=>{se(),X()},T=P({}),u=P({}),oe=()=>{!t.product_id||parseInt(t.product_id)<=0||_e(t.product_id).then(l=>{l.data.periods=l.data.periods.sort((e,o)=>e-o),Object.keys(T).forEach(e=>{delete T[e]}),l.data.periods.forEach(e=>{T[e]=Ne[e]}),Object.keys(u).forEach(e=>{delete u[e]}),Object.assign(u,P(l.data.cost))})},X=()=>{if(!t.product_id||parseInt(t.product_id)<=0){t.product_price={};return}if(!t.level_codes||t.level_codes.length<=0){t.product_price={};return}we(t.product_id,t.level_codes).then(l=>{l.data&&(t.product_price=l.data)})},ae=m(),q=m({}),w=m({}),v=m("all"),re=be(()=>{const l={};return Object.keys(u).length>0&&Object.keys(u).forEach(e=>{l[e]=x[e]||e}),l}),se=()=>{setTimeout(()=>{t.level_codes.length>0?Ie(t.level_codes).then(l=>{l.data.forEach(e=>{q.value[e.code]=e.name,w.value[e.code]=e.cost_rate})}):(q.value={},w.value={})},100)},K=P({custom:0}),B=m("base"),Z=()=>{t.level_codes=[],t.product_price={},Y.value++,B.value==="base"?(K.custom=0,he({custom:0}).then(l=>{l.data&&l.data.items&&(t.level_codes=l.data.items.map(e=>e.code),W())})):K.custom=1},ue=()=>{if(!u){y("成本价不存在，无法按比例设置",{type:"warning"});return}if(!v.value){y("请选择价格类型",{type:"warning"});return}for(const e in t.product_price){if(!w.value[e]){y(q.value[e]+"成本价比例不存在",{type:"warning"});return}const o=w.value[e],i=t.product_price[e];if(v.value==="all")for(const r in i)for(const f in i[r])u[r]&&u[r][f]&&(t.product_price[e][r][f]=(parseFloat(u[r][f])*o).toFixed(2));else if(i[v.value]&&u[v.value])for(const r in i[v.value])u[v.value][r]&&(t.product_price[e][v.value][r]=(parseFloat(u[v.value][r])*o).toFixed(2))}const l=v.value==="all"?"所有类型":x[v.value]||v.value;y(`已设置${l}的级别价格`,{type:"success"})},ne=()=>{if(Object.keys(t.product_price).length===0){y("请先设置价格",{type:"warning"});return}for(const l in t.product_price){const e=t.product_price[l];for(const o in e)for(const i in e[o]){const r=parseFloat(e[o][i]);isNaN(r)||(t.product_price[l][o][i]=Math.round(r).toString())}}y("已取整到元",{type:"success"})},de=()=>{if(Object.keys(t.product_price).length===0){y("请先设置价格",{type:"warning"});return}for(const l in t.product_price){const e=t.product_price[l];for(const o in e)for(const i in e[o]){const r=parseFloat(e[o][i]);isNaN(r)||(t.product_price[l][o][i]=(Math.round(r*10)/10).toFixed(1))}}y("已取整到角",{type:"success"})},ce=(l,e,o)=>{var V;const i=l.toString(),r=e.toString(),f=o.toString(),U=parseFloat(t.product_price[i][r][f]),j=parseFloat((V=u[r])==null?void 0:V[f]);if(!isNaN(U)&&!isNaN(j)&&j>0){const z=U/j;w.value[i]=parseFloat(z.toFixed(4))}},ie=()=>{A.value&&A.value.validate().then(l=>{l&&($.value=!0,Ce(parseInt(t.product_id.toString()),t.product_price).then(e=>{e.code===1&&(y("保存成功",{type:"success"}),J("saved"))}).finally(()=>{$.value=!1}))})},pe=P({product_id:[{required:!0,message:"请选择产品",trigger:"change"}],level_codes:[{required:!0,message:"请选择会员级别",trigger:"change"}]});return(l,e)=>{const o=_("el-form-item"),i=_("el-radio"),r=_("el-radio-group"),f=_("el-input"),U=_("el-option"),j=_("el-select"),V=_("el-button"),z=_("el-form"),ve=_("el-scrollbar"),fe=_("el-dialog"),me=Ve("loading");return n(),I(fe,{modelValue:N.value,"onUpdate:modelValue":e[5]||(e[5]=d=>N.value=d),class:"price-levels-dialog","close-on-click-modal":!1,width:"80%",onClose:e[6]||(e[6]=d=>N.value=!1)},{header:s(()=>e[7]||(e[7]=[a("div",{class:"title"},"设置会员价格",-1)])),footer:s(()=>[a("div",Be,[c(V,{onClick:e[4]||(e[4]=d=>N.value=!1)},{default:s(()=>e[20]||(e[20]=[S("关闭")])),_:1}),c(V,{loading:$.value,type:"primary",onClick:ie},{default:s(()=>e[21]||(e[21]=[S(" 保存 ")])),_:1},8,["loading"])])]),default:s(()=>[ye((n(),I(ve,{class:"form-scrollbar"},{default:s(()=>[a("div",Pe,[H.value?G("",!0):(n(),I(z,{key:0,ref_key:"formRef",ref:A,model:t,"label-position":"right","label-width":"80px",rules:pe},{default:s(()=>[c(o,{label:"产品",prop:"product_id"},{default:s(()=>[c(le(te),{modelValue:t.product_id,"onUpdate:modelValue":e[0]||(e[0]=d=>t.product_id=d),uri:"/product","value-field":"id","label-field":"name","search-field":"quickSearch",clearable:"",placeholder:"请选择产品",pageSize:100,showPagination:!1,onChange:Q},null,8,["modelValue"])]),_:1}),c(o,{label:"类型",prop:"user_level_type"},{default:s(()=>[c(r,{modelValue:B.value,"onUpdate:modelValue":e[1]||(e[1]=d=>B.value=d),onChange:Z},{default:s(()=>[c(i,{value:"base"},{default:s(()=>e[8]||(e[8]=[S("基础级别")])),_:1}),c(i,{value:"custom"},{default:s(()=>e[9]||(e[9]=[S("定制级别")])),_:1})]),_:1},8,["modelValue"])]),_:1}),c(o,{label:"会员级别"},{default:s(()=>[(n(),I(le(te),{key:Y.value,ref_key:"userLevelsRef",ref:ae,modelValue:t.level_codes,"onUpdate:modelValue":e[2]||(e[2]=d=>t.level_codes=d),queryParams:K,uri:"/user-level","value-field":"code","label-field":"name","search-field":"quickSearch",multiple:!0,"multiple-limit":10,"collapse-tags":!1,"automatic-dropdown":!0,"close-on-select":!1,clearable:"",placeholder:"请选择会员级别",onChange:W},null,8,["modelValue","queryParams"]))]),_:1}),(n(!0),g(h,null,L(t.product_price,(d,p)=>(n(),I(o,{key:p,prop:"product_price",label:q.value[p]},{default:s(()=>[a("div",null,[e[12]||(e[12]=a("div",{class:"price_label"},"成本价",-1)),a("div",Se,[e[10]||(e[10]=a("div",{class:"lable"},"比例",-1)),a("div",Le,[c(f,{modelValue:w.value[p],"onUpdate:modelValue":k=>w.value[p]=k},null,8,["modelValue","onUpdate:modelValue"])])]),e[13]||(e[13]=a("div",{class:"clear"},null,-1)),(n(!0),g(h,null,L(d,(k,C)=>(n(),g(h,{key:C},[a("div",Fe,E(x[C]),1),(n(!0),g(h,null,L(Object.keys(k),O=>(n(),g("div",{key:O,class:"price"},[a("div",Te,E(T[O]),1),a("div",Ue,[c(f,{modelValue:t.product_price[p][C][O],"onUpdate:modelValue":ee=>t.product_price[p][C][O]=ee,onInput:ee=>ce(p,C,O)},null,8,["modelValue","onUpdate:modelValue","onInput"])])]))),128)),e[11]||(e[11]=a("div",{class:"clear"},null,-1))],64))),128)),e[14]||(e[14]=a("div",{class:"clear"},null,-1))])]),_:2},1032,["label"]))),128)),Object.keys(u).length>0?(n(),I(o,{key:0,label:"成本价"},{default:s(()=>[a("div",null,[(n(!0),g(h,null,L(u,(d,p)=>(n(),g(h,{key:p},[a("div",je,E(x[p]),1),(n(!0),g(h,null,L(Object.keys(d),k=>(n(),g("div",{key:k,class:"price"},[a("div",Oe,E(T[k]),1),a("div",xe,[c(f,{modelValue:u[p][k],"onUpdate:modelValue":C=>u[p][k]=C},null,8,["modelValue","onUpdate:modelValue"])])]))),128)),e[15]||(e[15]=a("div",{class:"clear"},null,-1))],64))),128)),e[16]||(e[16]=a("div",{class:"clear"},null,-1))])]),_:1})):G("",!0),Object.keys(u).length>0?(n(),I(o,{key:1},{default:s(()=>[a("div",qe,[c(j,{modelValue:v.value,"onUpdate:modelValue":e[3]||(e[3]=d=>v.value=d),placeholder:"选择价格类型",style:{width:"120px","margin-right":"10px"}},{default:s(()=>[c(U,{label:"全部类型",value:"all"}),(n(!0),g(h,null,L(re.value,(d,p)=>(n(),I(U,{key:p,label:d,value:p},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),c(V,{type:"primary",onClick:ue},{default:s(()=>e[17]||(e[17]=[S(" 按比例设置价格 ")])),_:1}),c(V,{type:"info",onClick:ne},{default:s(()=>e[18]||(e[18]=[S(" 取整(元) ")])),_:1}),c(V,{type:"info",onClick:de},{default:s(()=>e[19]||(e[19]=[S(" 取整(角) ")])),_:1})])]),_:1})):G("",!0)]),_:1},8,["model","rules"]))])]),_:1})),[[me,H.value]])]),_:1},8,["modelValue"])}}}),Ge=ke(Ee,[["__scopeId","data-v-32811a08"]]);export{Ge as L,Me as b,ze as i};
