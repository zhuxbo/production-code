var ge=Object.defineProperty,ve=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var be=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable;var U=(o,a,l)=>a in o?ge(o,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):o[a]=l,D=(o,a)=>{for(var l in a||(a={}))be.call(a,l)&&U(o,l,a[l]);if(O)for(var l of O(a))_e.call(a,l)&&U(o,l,a[l]);return o},N=(o,a)=>ve(o,he(a));import{K as P,r as C,l as Ce,m as z,t as xe,n as ye,p as we,j as t,L as H,M as Se,v as ke,f as b,N as G,O as ze,e as K,F as W,q as E,G as Re,i as $,w as d,y as R,D as x,C as B,Q as j,_ as X,o as Te,x as Fe,g as L,u as e,k as Y,z as Pe,A as Ve,B as De,P as Ne}from"./index-2C-ofHV5.js";import{P as Ee}from"./plus-search-B1FvdIYy.js";import{_ as Q}from"./index.vue_vue_type_script_setup_true_lang-BHKqx4-E.js";import{O as J}from"./psl-D8AmD7_c.js";import{u as $e}from"./drawer-BlMYOobw.js";import{C as Be}from"./close-bold-Dru7IMTV.js";import{P as Me}from"./index-DtDmFput.js";import"./index-CaJyLCRQ.js";function Ae(o){return P.get("/delegation",{params:o})}const qe={user_id:0,zone:"",prefix:""};function Ie(o){return P.post("/delegation",{data:o})}function Oe(o){return P.post(`/delegation/check/${o}`)}function Ue(o){return P.delete("/delegation/batch",{data:{ids:o}})}function Ge(o){const a=C({}),l=C([]),g=C(!0),i=Ce({total:0,pageSize:20,currentPage:1,background:!0,pageSizes:[10,20,50,100]});function h(s){i.pageSize=s,m()}function r(s){i.currentPage=s,m()}const f=s=>{Ue(s).then(()=>{z("删除成功",{type:"success"}),m()})},v=s=>{Oe(s).then(p=>{z(p.msg||"检查完成",{type:"success"}),m()}).catch(p=>{z(p.message||"检查失败",{type:"error"})})};function m(){g.value=!0;const s=N(D({},xe(a.value)),{pageSize:i.pageSize,currentPage:i.currentPage});Ae(s).then(({data:p})=>{l.value=p.items,i.total=p.total,i.pageSize=p.pageSize,i.currentPage=p.currentPage,ye(()=>{o.value&&o.value.getTableRef().clearSelection()})}).finally(()=>{g.value=!1})}return{loading:g,search:a,dataList:l,pagination:i,handleSizeChange:h,handleCurrentChange:r,onSearch:m,onReset:()=>{m()},onCollapse:()=>{setTimeout(()=>{window.dispatchEvent(new Event("resize"))},500)},handleBatchDestroy:f,handleCheck:v}}const We=o=>{const a=we(()=>{o()},500);return{searchColumns:[{label:"快速搜索",prop:"quickSearch",valueType:"input",fieldProps:{placeholder:"用户名/邮箱/域名/标签"},onChange:()=>{a()}},{label:"用户",prop:"user_id",valueType:"select",renderField:(g,i)=>t(Q,{modelValue:g,uri:"/user",searchField:"quickSearch",labelField:"username",valueField:"id",itemsField:"items",totalField:"total",placeholder:"请选择用户",onChange:h=>{i(h),a()}},null)},{label:"委托域",prop:"zone",valueType:"input",fieldProps:{placeholder:"请输入域名"},onChange:()=>{a()}},{label:"委托前缀",prop:"prefix",valueType:"select",options:[{label:"_acme-challenge",value:"_acme-challenge"},{label:"_dnsauth",value:"_dnsauth"},{label:"_pki-validation",value:"_pki-validation"},{label:"_certum",value:"_certum"}],fieldProps:{placeholder:"请选择前缀"}},{label:"状态",prop:"valid",valueType:"select",options:[{label:"有效",value:!0},{label:"无效",value:!1}],fieldProps:{placeholder:"请选择状态"}}]}},je=(o,a)=>{const l=C(!1),g=C(),i=C(0),h=C({}),r=[{label:"用户",prop:"user_id",valueType:"select",renderField:(s,p)=>t(Q,{modelValue:s,uri:"/user",searchField:"quickSearch",labelField:"username",valueField:"id",itemsField:"items",totalField:"total",placeholder:"请选择用户",onChange:p,refreshKey:i.value},null)},{label:"委托域",prop:"zone",valueType:"input",fieldProps:{placeholder:"例如: example.com"},renderExtra:()=>H("div",{style:{fontSize:"12px",color:"#909399",marginTop:"5px"}})},{label:"委托前缀",prop:"prefix",valueType:"select",options:[{label:"_certum",value:"_certum"},{label:"_pki-validation",value:"_pki-validation"},{label:"_dnsauth",value:"_dnsauth"},{label:"_acme-challenge",value:"_acme-challenge"}],fieldProps:{placeholder:"请选择委托前缀",selectFirstOption:!1}}],f={user_id:[{required:!0,message:"请选择用户"},{type:"number",min:1,message:"用户ID必须大于0"}],zone:[{required:!0,message:"请输入委托域",trigger:"blur"},{pattern:/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i,message:"请输入正确的域名格式",trigger:"blur"}],prefix:[{required:!0,message:"请选择委托前缀",trigger:"change"}]};function v(s=0){var p,w;if(l.value=!0,s>0){z("委托记录不支持编辑，请删除后重新创建",{type:"warning"}),l.value=!1;return}else(w=(p=g.value)==null?void 0:p.formInstance)==null||w.resetFields(),h.value=Object.fromEntries(Object.entries(qe).filter(([T,S])=>S!==0&&S!==""));i.value=s}function m(){n()}function u(){l.value=!1}const n=()=>{Ie(h.value).then(s=>{o(),l.value=!1,s.data&&s.data.cname_to&&a(s.data)})};return{storeRef:g,showStore:l,storeId:i,storeValues:h,storeColumns:r,rules:f,openStoreForm:v,confirmStoreForm:m,closeStoreForm:u}},Le=()=>{const o=C(),a=C([]),l=r=>{a.value=r.map(f=>f.id),o.value.setAdaptive()},g=()=>{var r;(r=o.value)==null||r.getTableRef().clearSelection()},i=[{label:"勾选列",type:"selection",reserveSelection:!0},{label:"ID",prop:"id",minWidth:80},{label:"用户名",prop:"user.username",minWidth:120,cellRenderer:Se("user.username")},{label:"委托域",prop:"zone",minWidth:150},{label:"委托前缀",prop:"prefix",width:150,cellRenderer:({row:r})=>{var v;const f=((v=J(r.cname_to.host))==null?void 0:v.subdomain)||"";return t("div",{className:"flex items-center gap-1"},[t("span",null,[f||"-"]),t(b("el-button"),{link:!0,size:"small",onClick:m=>{m.stopPropagation(),navigator.clipboard.writeText(f).then(()=>{z("委托前缀已复制到剪贴板",{type:"success"})})},className:"!p-0 !m-0 !mt-1 !bg-transparent !border-none !shadow-none align-middle text-gray-500 hover:text-blue-500"},{default:()=>[t(b("el-icon"),{size:"14"},{default:()=>[t(G,null,null)]})]})])}},{label:"CNAME目标",prop:"target_fqdn",minWidth:200,cellRenderer:({row:r})=>{const f=r.target_fqdn;return t("div",{className:"flex items-center gap-1"},[t("span",null,[f||"-"]),t(b("el-button"),{link:!0,size:"small",onClick:v=>{v.stopPropagation(),navigator.clipboard.writeText(f).then(()=>{z("CNAME目标已复制到剪贴板",{type:"success"})})},className:"!p-0 !m-0 !mt-1 !bg-transparent !border-none !shadow-none align-middle text-gray-500 hover:text-blue-500"},{default:()=>[t(b("el-icon"),{size:"14"},{default:()=>[t(G,null,null)]})]})])}},{label:"状态",prop:"valid",width:100,cellRenderer:({row:r})=>H(ze,{type:r.valid?"success":"danger"},{default:()=>r.valid?"有效":"无效"})},{label:"失败次数",prop:"fail_count",width:100},{label:"上次检查",prop:"last_checked_at",width:180,formatter:({last_checked_at:r})=>r?ke(r).format("YYYY-MM-DD HH:mm:ss"):"-"},{label:"操作",fixed:"right",slot:"operation",width:220}];return{tableRef:o,selectedIds:a,handleSelectionChange:l,handleSelectionCancel:g,tableColumns:i,handleRowClick:(r,f,v)=>{var u;const m=v.target;m.tagName==="BUTTON"||m.closest("button")||m.closest(".el-button")||(u=o.value)==null||u.getTableRef().toggleRowSelection(r)}}},Ye={class:"cname-guide-content"},He={class:"break-all whitespace-normal"},Ke=K({__name:"CnameGuide",props:{modelValue:{type:Boolean,default:!1},options:{default:null}},emits:["update:modelValue"],setup(o,{emit:a}){const l=o,g=a,i=C(l.modelValue);W(()=>l.modelValue,u=>{i.value=u}),W(i,u=>{g("update:modelValue",u)});const h=E(()=>{const u=window.innerWidth;return u<768?"95vw":u<1024?"80vw":(u<1440,"720px")}),r=E(()=>{var u,n,s;return!((u=l.options)!=null&&u.cname_to)||!((n=l.options)!=null&&n.zone)?"":((s=J(l.options.cname_to.host))==null?void 0:s.subdomain)||""}),f=E(()=>{var u,n;return((n=(u=l.options)==null?void 0:u.cname_to)==null?void 0:n.value)||""}),v=u=>{navigator.clipboard.writeText(u).then(()=>{j.success("复制成功")}).catch(()=>{j.error("复制失败")})},m=()=>{};return(u,n)=>{const s=b("el-alert"),p=b("el-button"),w=b("el-descriptions-item"),T=b("el-descriptions"),S=b("el-dialog");return $(),Re(S,{modelValue:i.value,"onUpdate:modelValue":n[3]||(n[3]=y=>i.value=y),title:"CNAME 配置指引",width:h.value,draggable:"",onClosed:m},{footer:d(()=>[t(p,{type:"primary",onClick:n[2]||(n[2]=y=>i.value=!1)},{default:d(()=>[...n[9]||(n[9]=[x(" 知道了 ",-1)])]),_:1})]),default:d(()=>[R("div",Ye,[t(s,{type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:d(()=>[...n[4]||(n[4]=[x(" 请在 DNS 服务商处添加以下 CNAME 记录： ",-1)])]),_:1}),t(T,{column:1,border:"","label-width":"6em"},{default:d(()=>[t(w,{label:"主机记录"},{default:d(()=>[R("span",null,B(r.value),1),t(p,{link:"",type:"primary",onClick:n[0]||(n[0]=y=>v(r.value))},{default:d(()=>[...n[5]||(n[5]=[x(" 复制 ",-1)])]),_:1})]),_:1}),t(w,{label:"记录类型"},{default:d(()=>[...n[6]||(n[6]=[x(" CNAME ",-1)])]),_:1}),t(w,{label:"记录值"},{default:d(()=>[R("span",He,B(f.value),1),t(p,{link:"",type:"primary",onClick:n[1]||(n[1]=y=>v(f.value))},{default:d(()=>[...n[7]||(n[7]=[x(" 复制 ",-1)])]),_:1})]),_:1})]),_:1}),t(s,{type:"warning",closable:!1,style:{"margin-top":"20px"}},{default:d(()=>[...n[8]||(n[8]=[x(" 配置后，请等待 DNS 解析生效（通常 5-10 分钟），之后使用 TXT 解析验证的订单会自动进行验证 ",-1)])]),_:1})])]),_:1},8,["modelValue","width"])}}}),Xe=X(Ke,[["__scopeId","data-v-e6759cf5"]]),Qe={class:"main"},Je={class:"search bg-bg_color w-[99/100] pl-4 pr-4 pt-[24px] pb-[12px] overflow-auto"},Ze={key:0,class:"bg-[var(--el-fill-color-light)] w-full h-[46px] mb-2 pl-3 pr-2 flex items-center"},et={class:"flex-auto"},tt={style:{"font-size":"var(--el-font-size-base)"},class:"text-[rgba(42,46,54,0.5)] dark:text-[rgba(220,220,242,0.5)] ml-2"},lt=K({name:"Delegation",__name:"index",setup(o){const{drawerSize:a}=$e(),l=C(!1),g=C(null),i=A=>{g.value=A,l.value=!0},{tableRef:h,selectedIds:r,handleSelectionChange:f,handleSelectionCancel:v,tableColumns:m,handleRowClick:u}=Le(),{loading:n,search:s,dataList:p,pagination:w,handleSizeChange:T,handleCurrentChange:S,onSearch:y,onReset:Z,onCollapse:ee,handleCheck:te,handleBatchDestroy:M}=Ge(h),{searchColumns:le}=We(()=>y()),{storeRef:oe,showStore:ne,storeId:ae,storeColumns:se,rules:re,storeValues:V,openStoreForm:ie,confirmStoreForm:ue,closeStoreForm:de}=je(()=>y(),i);return Te(()=>{y()}),(A,c)=>{const k=b("el-button"),ce=b("el-tooltip"),q=b("el-popconfirm"),pe=b("pure-table"),me=Fe("motion-fade");return $(),L("div",Qe,[R("div",Je,[t(e(Ee),{modelValue:e(s),"onUpdate:modelValue":c[0]||(c[0]=_=>Y(s)?s.value=_:null),columns:e(le),"show-number":1,"row-props":{gutter:12},"col-props":{xs:24,sm:12,md:8,lg:6,xl:4},"label-width":"80","label-position":"right","label-suffix":"","search-text":"搜索","reset-text":"重置","expand-text":"展开","retract-text":"收起",onSearch:e(y),onReset:e(Z),onCollapse:e(ee)},null,8,["modelValue","columns","onSearch","onReset","onCollapse"])]),t(e(Ne),{title:"CNAME 委托管理",columns:e(m),onRefresh:e(y)},{buttons:d(()=>[t(k,{type:"primary",onClick:c[1]||(c[1]=_=>e(ie)())},{default:d(()=>[...c[5]||(c[5]=[x(" 新建委托 ",-1)])]),_:1})]),default:d(({size:_,dynamicColumns:fe})=>[e(r).length>0?Pe(($(),L("div",Ze,[R("div",et,[t(ce,{placement:"top",content:"取消选择"},{default:d(()=>[t(k,{type:"primary",size:"small",class:"!w-[15px] !p-0 !h-[15px] !rounded-[3px]",icon:e(De)(e(Be)),onClick:e(v)},null,8,["icon","onClick"])]),_:1}),R("span",tt," 已选 "+B(e(r).length)+" 项 ",1)]),t(q,{title:"确定要删除吗？",width:"160px",onConfirm:c[2]||(c[2]=F=>e(M)(e(r)))},{reference:d(()=>[t(k,{type:"danger",size:"small"},{default:d(()=>[...c[6]||(c[6]=[x(" 批量删除 ",-1)])]),_:1})]),_:1})])),[[me]]):Ve("",!0),t(pe,{ref_key:"tableRef",ref:h,"row-key":"id","align-whole":"left","table-layout":"auto",loading:e(n),size:_,adaptive:"",adaptiveConfig:{offsetBottom:108},data:e(p),columns:fe,pagination:N(D({},e(w)),{size:_}),"header-cell-style":{background:"var(--el-fill-color-light)",color:"var(--el-text-color-primary)"},onRowClick:e(u),onSelectionChange:e(f),onPageSizeChange:e(T),onPageCurrentChange:e(S)},{operation:d(({row:F})=>[t(k,{class:"reset-margin !outline-none",type:"primary",link:"",size:_,onClick:I=>i(F)},{default:d(()=>[...c[7]||(c[7]=[x(" 配置指引 ",-1)])]),_:1},8,["size","onClick"]),t(k,{class:"reset-margin !outline-none",type:"primary",link:"",size:_,onClick:I=>e(te)(F.id)},{default:d(()=>[...c[8]||(c[8]=[x(" 检查 ",-1)])]),_:1},8,["size","onClick"]),t(q,{title:"确定要删除吗？删除后将不再自动写入 TXT 记录",width:"220px",onConfirm:I=>e(M)([F.id])},{reference:d(()=>[t(k,{class:"reset-margin !outline-none",link:"",type:"danger",size:_},{default:d(()=>[...c[9]||(c[9]=[x(" 删除 ",-1)])]),_:1},8,["size"])]),_:2},1032,["onConfirm"])]),_:2},1032,["loading","size","data","columns","pagination","onRowClick","onSelectionChange","onPageSizeChange","onPageCurrentChange"])]),_:1},8,["columns","onRefresh"]),t(e(Me),{ref_key:"storeRef",ref:oe,modelValue:e(V),"onUpdate:modelValue":c[3]||(c[3]=_=>Y(V)?V.value=_:null),visible:e(ne),form:{columns:e(se),rules:e(re),labelPosition:"right",labelSuffix:""},size:e(a),closeOnClickModal:!0,title:e(ae)>0?"编辑委托":"新建委托",confirmText:"提交",cancelText:"取消",onConfirm:e(ue),onCancel:e(de)},null,8,["modelValue","visible","form","size","title","onConfirm","onCancel"]),t(Xe,{modelValue:l.value,"onUpdate:modelValue":c[4]||(c[4]=_=>l.value=_),options:g.value},null,8,["modelValue","options"])])}}}),pt=X(lt,[["__scopeId","data-v-2b0da142"]]);export{pt as default};
