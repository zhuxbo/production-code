var me=Object.defineProperty,fe=Object.defineProperties;var ve=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var be=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable;var G=(e,l,t)=>l in e?me(e,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[l]=t,S=(e,l)=>{for(var t in l||(l={}))be.call(l,t)&&G(e,t,l[t]);if(H)for(var t of H(l))ge.call(l,t)&&G(e,t,l[t]);return e},U=(e,l)=>fe(e,ve(l));import{u as ye,g as he,b as we,a as ke,c as Ce}from"./auth-8X049xxM.js";import{r as v,m as u,e as _,p as Z,k as n,l as C,b5 as Ve,z as D,i as w,b4 as L,aX as k,b6 as Pe,C as q,q as M,b7 as _e,b8 as X,b9 as xe,ba as Ie,F as E,v as P,x as R,G as o,H as B,y as h,u as Te,ad as J,ae as K,A as $,_ as Ae}from"./index-D5efkW8k.js";import{u as Se}from"./user-DCOGtfwP.js";import{i as Q}from"./isIP-De3RazRf.js";import{s as Ue,a as Ee}from"./verifyCode-Dcp6w-MG.js";import{P as F}from"./index-CsaBZZ8X.js";const Re=()=>{const e=v({oldPassword:"",newPassword:""});return{passwordValues:e,passwordColumns:[{label:"旧密码",prop:"oldPassword",valueType:"input",fieldProps:{placeholder:"请输入旧密码"}},{label:"新密码",prop:"newPassword",valueType:"input",fieldProps:{placeholder:"请输入新密码"}}],passwordRules:{oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,max:32,message:"密码长度应在6-32个字符之间",trigger:"blur"},{validator:(s,a,d)=>{a&&a===e.value.oldPassword&&d(new Error("新密码不能与旧密码相同")),d()}}]},handlePasswordUpdate:()=>{ye(e.value).then(()=>{u("更新成功",{type:"success"}),Se().logOut()})},resetPassword:()=>{e.value.oldPassword="",e.value.newPassword=""}}};function Be(){return _.get("/setting/api-token")}function Fe(e){return _.put("/setting/api-token",{data:e})}function De(){return _.get("/setting/callback")}function qe(e){return _.put("/setting/callback",{data:e})}function Ne(){return _.get("/setting/notification-preferences")}function Oe(e){return _.put("/setting/notification-preferences",{data:e})}const ze=Z({name:"IpArrayInput",props:{modelValue:{type:Array,default:()=>[]},maxItems:{type:Number,default:10}},emits:["update:modelValue"],setup(e,{emit:l}){const t=v(Array(e.modelValue.length).fill("")),i=(r,c)=>r?!Q(r,4)&&!Q(r,6)?(t.value[c]="请输入有效的IP地址",!1):(t.value[c]="",!0):(t.value[c]="IP地址不能为空",!1);return{ipErrors:t,addItem:()=>{const r=[...e.modelValue,""];t.value.push(""),l("update:modelValue",r)},removeItem:r=>{const c=[...e.modelValue];c.splice(r,1),t.value.splice(r,1),l("update:modelValue",c)},updateItem:(r,c)=>{const V=[...e.modelValue];V[r]=c,l("update:modelValue",V)},validateOnBlur:r=>{i(e.modelValue[r],r)},validate:()=>{if(e.modelValue.length>e.maxItems)return{valid:!1,message:`IP白名单不能超过${e.maxItems}个`};for(let r=0;r<e.modelValue.length;r++)if(!i(e.modelValue[r],r))return{valid:!1,message:t.value[r]};return{valid:!0}}}},render(){return n("div",null,[this.modelValue.map((e,l)=>n("div",{class:"flex flex-col mb-2",key:l},[n("div",{class:"flex items-center"},[n(C("el-input"),{modelValue:e,placeholder:`IP地址 ${l+1}`,"onUpdate:modelValue":t=>this.updateItem(l,t),onBlur:()=>this.validateOnBlur(l),status:this.ipErrors[l]?"error":""},null),n(C("el-button"),{type:"danger",size:"small",plain:!0,class:"ml-2",onClick:()=>this.removeItem(l)},{default:()=>[n(C("el-icon"),null,{default:()=>[n(Ve,null,null)]})]})]),this.ipErrors[l]&&n("div",{class:"text-red-500 text-xs mt-1"},[this.ipErrors[l]])])),n(C("el-button"),{type:"primary",size:"small",plain:!0,class:"mt-2",onClick:this.addItem},{default:()=>[D("添加IP")]}),this.modelValue.length>this.maxItems&&n("div",{class:"text-red-500 text-xs mt-1"},[D("IP白名单不能超过"),this.maxItems,D("个")])])}}),W=()=>window.location.href.replace("/user/setting","/api/v2"),Le=()=>{const e=v({token:"",allowed_ips:[]}),l=v(),t=[{label:"API地址",prop:"api_url",valueType:"input",fieldProps:{value:W(),disabled:!0},fieldSlots:{suffix:()=>w(k,{circle:!0,type:"primary",plain:!0,link:!0,onClick:()=>{navigator.clipboard.writeText(W()).then(()=>{u("API地址已复制到剪贴板",{type:"success"})}).catch(()=>{u("复制失败",{type:"error"})})}},()=>w(L,{icon:"ep/copy-document"}))}},{label:"API Token",prop:"token",valueType:"input",fieldProps:{placeholder:"请输入API Token"},fieldSlots:{suffix:()=>[w(k,{circle:!0,type:"success",plain:!0,link:!0,onClick:()=>{e.value.token=Pe(64)}},()=>w(L,{icon:"ep/circle-plus"})),w(k,{circle:!0,type:"primary",plain:!0,link:!0,onClick:()=>{e.value.token?navigator.clipboard.writeText(e.value.token).then(()=>{u("Token已复制到剪贴板",{type:"success"})}).catch(()=>{u("复制失败",{type:"error"})}):u("请先生成Token",{type:"warning"})}},()=>w(L,{icon:"ep/copy-document"}))]}},{label:"IP白名单",prop:"allowed_ips",renderField:(a,d)=>{const f=Array.isArray(a)?a:a?[a]:[];return n(ze,{ref:l,modelValue:f,"onUpdate:modelValue":d,maxItems:10},null)}}];q(()=>{s()});const i={token:[{min:32,max:128,message:"请输入32-128个字符",trigger:"blur"}]},p=()=>{Fe(e.value).then(()=>{u("更新成功",{type:"success"})})},s=()=>{e.value.token="",Be().then(a=>{var d;e.value.allowed_ips=((d=a.data)==null?void 0:d.allowed_ips)||[]})};return{apiValues:e,apiColumns:t,apiRules:i,handleApiUpdate:p,resetApiToken:s}},$e=()=>{const e=v({url:"",token:"",status:0}),l=M(()=>e.value.status===0),t=[{label:"回调地址",prop:"url",valueType:"input",fieldProps:{placeholder:"请输入回调地址",get disabled(){return l.value}}},{label:"回调 Token",prop:"token",valueType:"input",fieldProps:{placeholder:"请输入回调 Token",get disabled(){return l.value}}},{label:"状态",prop:"status",valueType:"switch",fieldProps:{activeValue:1,inactiveValue:0},onChange:a=>{a===0&&(e.value.url="",e.value.token="",e.value.status=0)}}],i=M(()=>({url:[{required:!l.value,message:"请输入回调地址",trigger:"blur"},{pattern:/^https?:\/\/.+/,message:"请输入有效的URL地址（以http://或https://开头）",trigger:"blur"}],token:[{required:!l.value,message:"请输入回调Token",trigger:"blur"},{min:32,max:128,message:"请输入32-128个字符",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"blur"}]}));q(()=>{s()});const p=()=>{qe(e.value).then(()=>{u("更新成功",{type:"success"})})},s=()=>{De().then(a=>{a!=null&&a.data&&(e.value.url=a.data.url,e.value.token=a.data.token,e.value.status=a.data.status)})};return{callbackValues:e,callbackColumns:t,callbackRules:i,handleCallbackUpdate:p,resetCallback:s}},Y=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,ee=/^1[3-9]\d{9}$/,Me=()=>{const e=v({username:"",email:"",mobile:"",token:""}),l=v(!1),t=v("email"),i=v(""),p=v(0);let s=null;const a=()=>{p.value=60,s=window.setInterval(()=>{p.value--,p.value<=0&&s&&(clearInterval(s),s=null)},1e3)},d=()=>{t.value==="email"?Ue({email:e.value.email,type:"bind"}).then(()=>{a(),u("验证码已发送",{type:"success"})}).catch(()=>{u("发送验证码失败",{type:"error"})}):Ee({mobile:e.value.mobile,type:"bind"}).then(()=>{a(),u("验证码已发送",{type:"success"})}).catch(()=>{u("发送验证码失败",{type:"error"})})},f=()=>{t.value==="email"?we({email:e.value.email,code:i.value}).then(()=>{l.value=!1,u("绑定成功",{type:"success"})}).catch(()=>{u("绑定失败",{type:"error"})}):ke({mobile:e.value.mobile,code:i.value}).then(()=>{l.value=!1,u("绑定成功",{type:"success"})}).catch(()=>{u("绑定失败",{type:"error"})})},r=g=>{t.value=g,l.value=!0,i.value="",s&&(clearInterval(s),s=null),p.value=0},c=[{label:"用户名",prop:"username",valueType:"input",fieldProps:{placeholder:"请输入用户名"},fieldSlots:{append:()=>w(k,{type:"primary",onClick:()=>{x()}},()=>"保存")}},{label:"邮箱",prop:"email",valueType:"input",fieldProps:{placeholder:"请输入邮箱"},fieldSlots:{append:()=>w(k,{type:"primary",onClick:()=>{N()}},()=>"保存")}},{label:"手机号",prop:"mobile",valueType:"input",fieldProps:{placeholder:"请输入手机号"},fieldSlots:{append:()=>w(k,{type:"primary",onClick:()=>{O()}},()=>"保存")}}];q(()=>{he().then(g=>{e.value.username=g.data.username,e.value.email=g.data.email,e.value.mobile=g.data.mobile})});const V={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:16,message:"请输入3-16个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{validator:(g,I,y)=>{Y.test(I)?y():y(new Error("请输入正确的邮箱格式"))},trigger:"blur"}],mobile:[{required:!0,message:"请输入手机号",trigger:"blur"},{validator:(g,I,y)=>{ee.test(I)?y():y(new Error("请输入正确的手机号格式"))},trigger:"blur"}]},x=()=>{Ce({username:e.value.username}).then(()=>{u("更新成功",{type:"success"})})},N=()=>{if(!Y.test(e.value.email)){u("请输入正确的邮箱格式",{type:"error"});return}r("email")},O=()=>{if(!ee.test(e.value.mobile)){u("请输入正确的手机号格式",{type:"error"});return}r("mobile")};return{profileValues:e,profileColumns:c,profileRules:V,verifyDialogVisible:l,verifyType:t,verifyCode:i,countdown:p,handleSendCode:d,handleVerifySubmit:f}},Ze=Z({props:{visible:Boolean,type:{type:String,required:!0},countdown:Number,verifyCode:String,onSendCode:Function,onSubmit:Function,onClose:Function,onUpdateVerifyCode:Function},setup(e){return()=>n(Ie,{modelValue:e.visible,title:e.type==="email"?"绑定邮箱":"绑定手机号",width:"320px",onClose:e.onClose},{default:()=>[n(_e,null,{default:()=>[n(X,null,{default:()=>[n("div",{class:"flex items-center"},[n(xe,{modelValue:e.verifyCode,"onUpdate:modelValue":l=>{var t;return(t=e.onUpdateVerifyCode)==null?void 0:t.call(e,l)},placeholder:"请输入验证码",class:"mr-3"},null),n(k,{type:"primary",disabled:e.countdown>0,onClick:e.onSendCode},{default:()=>[e.countdown>0?`${e.countdown}s后重试`:"获取验证码"]})])]}),n(X,null,{default:()=>[n(k,{type:"primary",onClick:e.onSubmit},{default:()=>[D("确认绑定")]})]})]})]})}}),je={mail:"邮件通知",sms:"短信通知"},He={cert_issued:"证书签发通知",cert_expire:"证书到期提醒",security:"安全提醒"},Ge=()=>{const e=v({}),l=v(!1),t=()=>{l.value=!0,Ne().then(s=>{var a;e.value=(a=s.data)!=null?a:{}}).finally(()=>{l.value=!1})};q(()=>{t()});const i=M(()=>Object.entries(e.value).map(([s,a])=>{var d;return{key:s,label:(d=je[s])!=null?d:s,items:Object.entries(a).map(([f,r])=>{var c;return{type:f,label:(c=He[f])!=null?c:f,value:r}})}}));return{notificationValues:e,notificationChannels:i,notificationLoading:l,handleToggle:(s,a,d)=>{if(!e.value[s])return;const f=e.value[s][a];f!==d&&(e.value=U(S({},e.value),{[s]:U(S({},e.value[s]),{[a]:d})}),Oe(e.value).then(()=>{u("通知设置已更新",{type:"success"})}).catch(()=>{u("更新失败，请重试",{type:"error"}),e.value=U(S({},e.value),{[s]:U(S({},e.value[s]),{[a]:f})})}))}}},Xe={class:"flex flex-col gap-4"},Je={class:"notification-channel__title"},Ke={class:"notification-channel__items"},Qe={class:"notification-item__label"},We=Z({name:"Setting",__name:"index",setup(e){const{profileColumns:l,profileRules:t,profileValues:i,verifyDialogVisible:p,verifyType:s,verifyCode:a,countdown:d,handleSendCode:f,handleVerifySubmit:r}=Me(),{passwordColumns:c,passwordRules:V,passwordValues:x,handlePasswordUpdate:N,resetPassword:O}=Re(),{apiColumns:g,apiRules:I,apiValues:y,handleApiUpdate:le,resetApiToken:te}=Le(),{callbackColumns:ae,callbackRules:oe,callbackValues:z,handleCallbackUpdate:se,resetCallback:ne}=$e(),{notificationValues:re,notificationChannels:j,notificationLoading:ue,handleToggle:ie}=Ge();return(Ye,b)=>{const T=C("el-card"),de=C("el-empty"),ce=C("el-switch");return P(),E("div",Xe,[n(T,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:R(()=>[n(o(F),{modelValue:o(i),"onUpdate:modelValue":b[0]||(b[0]=m=>B(i)?i.value=m:null),columns:o(l),rules:o(t),"label-width":"100","label-position":"right","label-suffix":"","has-footer":!1},null,8,["modelValue","columns","rules"])]),_:1}),n(T,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:R(()=>[n(o(F),{modelValue:o(x),"onUpdate:modelValue":b[1]||(b[1]=m=>B(x)?x.value=m:null),columns:o(c),rules:o(V),"label-width":"100","label-position":"right","label-suffix":"","footer-align":"right","submit-text":"保存","reset-text":"重置",onSubmit:o(N),onReset:o(O)},null,8,["modelValue","columns","rules","onSubmit","onReset"])]),_:1}),n(T,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:R(()=>[n(o(F),{modelValue:o(y),"onUpdate:modelValue":b[2]||(b[2]=m=>B(y)?y.value=m:null),columns:o(g),rules:o(I),"label-width":"100","label-position":"right","label-suffix":"","footer-align":"right","submit-text":"保存","reset-text":"重置",onSubmit:o(le),onReset:o(te)},null,8,["modelValue","columns","rules","onSubmit","onReset"])]),_:1}),n(T,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:R(()=>[n(o(F),{modelValue:o(z),"onUpdate:modelValue":b[3]||(b[3]=m=>B(z)?z.value=m:null),columns:o(ae),rules:o(oe),"label-width":"100","label-position":"right","label-suffix":"","footer-align":"right","submit-text":"保存","reset-text":"重置",onSubmit:o(se),onReset:o(ne)},null,8,["modelValue","columns","rules","onSubmit","onReset"])]),_:1}),n(T,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:R(()=>[b[4]||(b[4]=h("div",{class:"notification-card__header"},[h("div",null,[h("div",{class:"notification-card__title"},"通知设置"),h("div",{class:"notification-card__desc"}," 选择是否接收来自不同渠道的通知提醒 ")])],-1)),o(j).length===0?(P(),Te(de,{key:0,description:"暂无可配置的通知类型"})):(P(!0),E(J,{key:1},K(o(j),m=>(P(),E("div",{key:m.key,class:"notification-channel"},[h("div",Je,$(m.label),1),h("div",Ke,[(P(!0),E(J,null,K(m.items,A=>(P(),E("div",{key:A.type,class:"notification-item"},[h("div",Qe,[h("span",null,$(A.label),1),h("small",null,$(A.type),1)]),n(ce,{"model-value":o(re)[m.key][A.type],loading:o(ue),onChange:pe=>o(ie)(m.key,A.type,pe)},null,8,["model-value","loading","onChange"])]))),128))])]))),128))]),_:1}),n(o(Ze),{visible:o(p),type:o(s),countdown:o(d),verifyCode:o(a),onSendCode:o(f),onSubmit:o(r),onClose:()=>p.value=!1,onUpdateVerifyCode:m=>a.value=m},null,8,["visible","type","countdown","verifyCode","onSendCode","onSubmit","onClose","onUpdateVerifyCode"])])}}}),rl=Ae(We,[["__scopeId","data-v-212527a4"]]);export{rl as default};
