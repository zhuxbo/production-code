import{l as c,a_ as L,y as d,aa as G,k as U,d as B,e as a,r as k,a$ as J,h as T,v as F,ak as P,b0 as K,b1 as Q,aR as w,aA as W,b2 as X,b3 as D,b4 as Y,b5 as ee,b6 as le,b7 as ae,b8 as te,c as oe,o as se,j as x,g as l,x as A,_ as re}from"./index-Bu6_wWpk.js";import{i as q}from"./isIP-B383TtMi.js";import{s as ue,a as ne}from"./verifyCode-CWiNZvUm.js";import{P as S}from"./index-2D4voXNg.js";const ie=()=>{const e=c({oldPassword:"",newPassword:""});return{passwordValues:e,passwordColumns:[{label:"旧密码",prop:"oldPassword",valueType:"input",fieldProps:{placeholder:"请输入旧密码"}},{label:"新密码",prop:"newPassword",valueType:"input",fieldProps:{placeholder:"请输入新密码"}}],passwordRules:{oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,max:32,message:"密码长度应在6-32个字符之间",trigger:"blur"},{validator:(r,n,p)=>{n&&n===e.value.oldPassword&&p(new Error("新密码不能与旧密码相同")),p()}}]},handlePasswordUpdate:()=>{L(e.value).then(()=>{d("更新成功",{type:"success"}),G().logOut()})},resetPassword:()=>{e.value.oldPassword="",e.value.newPassword=""}}};function de(){return U.get("/setting/api-token")}function me(e){return U.put("/setting/api-token",{data:e})}function pe(){return U.get("/setting/callback")}function ce(e){return U.put("/setting/callback",{data:e})}const fe=B({name:"IpArrayInput",props:{modelValue:{type:Array,default:()=>[]},maxItems:{type:Number,default:10}},emits:["update:modelValue"],setup(e,{emit:t}){const o=c(Array(e.modelValue.length).fill("")),u=(s,m)=>s?!q(s,4)&&!q(s,6)?(o.value[m]="请输入有效的IP地址",!1):(o.value[m]="",!0):(o.value[m]="IP地址不能为空",!1);return{ipErrors:o,addItem:()=>{const s=[...e.modelValue,""];o.value.push(""),t("update:modelValue",s)},removeItem:s=>{const m=[...e.modelValue];m.splice(s,1),o.value.splice(s,1),t("update:modelValue",m)},updateItem:(s,m)=>{const h=[...e.modelValue];h[s]=m,t("update:modelValue",h)},validateOnBlur:s=>{u(e.modelValue[s],s)},validate:()=>{if(e.modelValue.length>e.maxItems)return{valid:!1,message:`IP白名单不能超过${e.maxItems}个`};for(let s=0;s<e.modelValue.length;s++)if(!u(e.modelValue[s],s))return{valid:!1,message:o.value[s]};return{valid:!0}}}},render(){return a("div",null,[this.modelValue.map((e,t)=>a("div",{class:"flex flex-col mb-2",key:t},[a("div",{class:"flex items-center"},[a(k("el-input"),{modelValue:e,placeholder:`IP地址 ${t+1}`,"onUpdate:modelValue":o=>this.updateItem(t,o),onBlur:()=>this.validateOnBlur(t),status:this.ipErrors[t]?"error":""},null),a(k("el-button"),{type:"danger",size:"small",plain:!0,class:"ml-2",onClick:()=>this.removeItem(t)},{default:()=>[a(k("el-icon"),null,{default:()=>[a(J,null,null)]})]})]),this.ipErrors[t]&&a("div",{class:"text-red-500 text-xs mt-1"},[this.ipErrors[t]])])),a(k("el-button"),{type:"primary",size:"small",plain:!0,class:"mt-2",onClick:this.addItem},{default:()=>[T("添加IP")]}),this.modelValue.length>this.maxItems&&a("div",{class:"text-red-500 text-xs mt-1"},[T("IP白名单不能超过"),this.maxItems,T("个")])])}}),be=()=>{const e=c({token:"",allowed_ips:[]}),t=c(),o=[{label:"API Token",prop:"token",valueType:"input",fieldProps:{placeholder:"请输入API Token"},fieldSlots:{suffix:()=>P(w,{circle:!0,type:"primary",plain:!0,link:!0,onClick:()=>{e.value.token=Q(64)}},()=>P(K,{icon:"ep:circle-plus"}))}},{label:"IP白名单",prop:"allowed_ips",renderField:(n,p)=>{const y=Array.isArray(n)?n:n?[n]:[];return a(fe,{ref:t,modelValue:y,"onUpdate:modelValue":p,maxItems:10},null)}}];F(()=>{r()});const u={token:[{min:32,max:128,message:"请输入32-128个字符",trigger:"blur"}]},i=()=>{me(e.value).then(()=>{d("更新成功",{type:"success"})})},r=()=>{e.value.token="",de().then(n=>{var p;e.value.allowed_ips=((p=n.data)==null?void 0:p.allowed_ips)||[]})};return{apiValues:e,apiColumns:o,apiRules:u,handleApiUpdate:i,resetApiToken:r}},ve=()=>{const e=c({url:"",token:"",status:0}),t=[{label:"回调地址",prop:"url",valueType:"input",fieldProps:{placeholder:"请输入回调地址"}},{label:"回调 Token",prop:"token",valueType:"input",fieldProps:{placeholder:"请输入回调 Token"}},{label:"状态",prop:"status",valueType:"switch",fieldProps:{activeValue:1,inactiveValue:0}}],o={url:[{required:!0,message:"请输入回调地址",trigger:"blur"},{pattern:/^https?:\/\/.+/,message:"请输入有效的URL地址（以http://或https://开头）",trigger:"blur"}],token:[{required:!0,message:"请输入回调Token",trigger:"blur"},{min:32,max:128,message:"请输入32-128个字符",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"blur"}]};F(()=>{i()});const u=()=>{ce(e.value).then(()=>{d("更新成功",{type:"success"})})},i=()=>{pe().then(r=>{r!=null&&r.data&&(e.value.url=r.data.url,e.value.token=r.data.token,e.value.status=r.data.status)})};return{callbackValues:e,callbackColumns:t,callbackRules:o,handleCallbackUpdate:u,resetCallback:i}},$=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,z=/^1[3-9]\d{9}$/,ge=()=>{const e=c({username:"",email:"",mobile:"",token:""}),t=c(!1),o=c("email"),u=c(""),i=c(0);let r=null;const n=()=>{i.value=60,r=window.setInterval(()=>{i.value--,i.value<=0&&r&&(clearInterval(r),r=null)},1e3)},p=()=>{o.value==="email"?ue({email:e.value.email,type:"bind"}).then(()=>{n(),d("验证码已发送",{type:"success"})}).catch(()=>{d("发送验证码失败",{type:"error"})}):ne({mobile:e.value.mobile,type:"bind"}).then(()=>{n(),d("验证码已发送",{type:"success"})}).catch(()=>{d("发送验证码失败",{type:"error"})})},y=()=>{o.value==="email"?le({email:e.value.email,code:u.value}).then(()=>{t.value=!1,d("绑定成功",{type:"success"})}).catch(()=>{d("绑定失败",{type:"error"})}):ae({mobile:e.value.mobile,code:u.value}).then(()=>{t.value=!1,d("绑定成功",{type:"success"})}).catch(()=>{d("绑定失败",{type:"error"})})},s=f=>{o.value=f,t.value=!0,u.value="",r&&(clearInterval(r),r=null),i.value=0},m=[{label:"用户名",prop:"username",valueType:"input",fieldProps:{placeholder:"请输入用户名"},fieldSlots:{append:()=>P(w,{type:"primary",onClick:()=>{V()}},()=>"保存")}},{label:"邮箱",prop:"email",valueType:"input",fieldProps:{placeholder:"请输入邮箱"},fieldSlots:{append:()=>P(w,{type:"primary",onClick:()=>{_()}},()=>"保存")}},{label:"手机号",prop:"mobile",valueType:"input",fieldProps:{placeholder:"请输入手机号"},fieldSlots:{append:()=>P(w,{type:"primary",onClick:()=>{R()}},()=>"保存")}}];F(()=>{W().then(f=>{e.value.username=f.data.username,e.value.email=f.data.email,e.value.mobile=f.data.mobile})});const h={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:16,message:"请输入3-16个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{validator:(f,C,b)=>{$.test(C)?b():b(new Error("请输入正确的邮箱格式"))},trigger:"blur"}],mobile:[{required:!0,message:"请输入手机号",trigger:"blur"},{validator:(f,C,b)=>{z.test(C)?b():b(new Error("请输入正确的手机号格式"))},trigger:"blur"}]},V=()=>{te({username:e.value.username}).then(()=>{d("更新成功",{type:"success"})})},_=()=>{if(!$.test(e.value.email)){d("请输入正确的邮箱格式",{type:"error"});return}s("email")},R=()=>{if(!z.test(e.value.mobile)){d("请输入正确的手机号格式",{type:"error"});return}s("mobile")};return{profileValues:e,profileColumns:m,profileRules:h,verifyDialogVisible:t,verifyType:o,verifyCode:u,countdown:i,handleSendCode:p,handleVerifySubmit:y}},ye=B({props:{visible:Boolean,type:{type:String,required:!0},countdown:Number,verifyCode:String,onSendCode:Function,onSubmit:Function,onClose:Function,onUpdateVerifyCode:Function},setup(e){return()=>a(ee,{modelValue:e.visible,title:e.type==="email"?"绑定邮箱":"绑定手机号",width:"320px",onClose:e.onClose},{default:()=>[a(X,null,{default:()=>[a(D,null,{default:()=>[a("div",{class:"flex items-center"},[a(Y,{modelValue:e.verifyCode,"onUpdate:modelValue":t=>{var o;return(o=e.onUpdateVerifyCode)==null?void 0:o.call(e,t)},placeholder:"请输入验证码",class:"mr-3"},null),a(w,{type:"primary",disabled:e.countdown>0,onClick:e.onSendCode},{default:()=>[e.countdown>0?`${e.countdown}s后重试`:"获取验证码"]})])]}),a(D,null,{default:()=>[a(w,{type:"primary",onClick:e.onSubmit},{default:()=>[T("确认绑定")]})]})]})]})}}),he={class:"flex flex-col gap-4"},we=B({name:"Setting",__name:"index",setup(e){const{profileColumns:t,profileRules:o,profileValues:u,verifyDialogVisible:i,verifyType:r,verifyCode:n,countdown:p,handleSendCode:y,handleVerifySubmit:s}=ge(),{passwordColumns:m,passwordRules:h,passwordValues:V,handlePasswordUpdate:_,resetPassword:R}=ie(),{apiColumns:f,apiRules:C,apiValues:b,handleApiUpdate:O,resetApiToken:N}=be(),{callbackColumns:M,callbackRules:Z,callbackValues:E,handleCallbackUpdate:j,resetCallback:H}=ve();return(Ve,g)=>{const I=k("el-card");return se(),oe("div",he,[a(I,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:x(()=>[a(l(S),{modelValue:l(u),"onUpdate:modelValue":g[0]||(g[0]=v=>A(u)?u.value=v:null),columns:l(t),rules:l(o),"label-width":"100","label-position":"right","label-suffix":"","has-footer":!1},null,8,["modelValue","columns","rules"])]),_:1}),a(I,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:x(()=>[a(l(S),{modelValue:l(V),"onUpdate:modelValue":g[1]||(g[1]=v=>A(V)?V.value=v:null),columns:l(m),rules:l(h),"label-width":"100","label-position":"right","label-suffix":"","footer-align":"right","submit-text":"保存","reset-text":"重置",onSubmit:l(_),onReset:l(R)},null,8,["modelValue","columns","rules","onSubmit","onReset"])]),_:1}),a(I,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:x(()=>[a(l(S),{modelValue:l(b),"onUpdate:modelValue":g[2]||(g[2]=v=>A(b)?b.value=v:null),columns:l(f),rules:l(C),"label-width":"100","label-position":"right","label-suffix":"","footer-align":"right","submit-text":"保存","reset-text":"重置",onSubmit:l(O),onReset:l(N)},null,8,["modelValue","columns","rules","onSubmit","onReset"])]),_:1}),a(I,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:x(()=>[a(l(S),{modelValue:l(E),"onUpdate:modelValue":g[3]||(g[3]=v=>A(E)?E.value=v:null),columns:l(M),rules:l(Z),"label-width":"100","label-position":"right","label-suffix":"","footer-align":"right","submit-text":"保存","reset-text":"重置",onSubmit:l(j),onReset:l(H)},null,8,["modelValue","columns","rules","onSubmit","onReset"])]),_:1}),a(l(ye),{visible:l(i),type:l(r),countdown:l(p),verifyCode:l(n),onSendCode:l(y),onSubmit:l(s),onClose:()=>i.value=!1,onUpdateVerifyCode:v=>n.value=v},null,8,["visible","type","countdown","verifyCode","onSendCode","onSubmit","onClose","onUpdateVerifyCode"])])}}}),xe=re(we,[["__scopeId","data-v-a86a83e5"]]);export{xe as default};
