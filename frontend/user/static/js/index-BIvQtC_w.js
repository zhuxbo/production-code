import{l as m,b0 as K,y as u,aa as Q,k as U,d as F,e as a,r as P,b1 as W,h as S,ak as y,a$ as B,aR as h,b2 as X,v as D,z as q,aA as Y,b3 as ee,b4 as z,b5 as le,b6 as te,b7 as ae,b8 as oe,b9 as se,c as re,o as ue,j as x,g as t,x as A,_ as ne}from"./index-JDF6RRmw.js";import{i as $}from"./isIP-BoUTYQB7.js";import{s as ie,a as de}from"./verifyCode-C-4boKzG.js";import{P as T}from"./index-CIyWJQQa.js";const pe=()=>{const e=m({oldPassword:"",newPassword:""});return{passwordValues:e,passwordColumns:[{label:"旧密码",prop:"oldPassword",valueType:"input",fieldProps:{placeholder:"请输入旧密码"}},{label:"新密码",prop:"newPassword",valueType:"input",fieldProps:{placeholder:"请输入新密码"}}],passwordRules:{oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,max:32,message:"密码长度应在6-32个字符之间",trigger:"blur"},{validator:(n,o,c)=>{o&&o===e.value.oldPassword&&c(new Error("新密码不能与旧密码相同")),c()}}]},handlePasswordUpdate:()=>{K(e.value).then(()=>{u("更新成功",{type:"success"}),Q().logOut()})},resetPassword:()=>{e.value.oldPassword="",e.value.newPassword=""}}};function ce(){return U.get("/setting/api-token")}function me(e){return U.put("/setting/api-token",{data:e})}function fe(){return U.get("/setting/callback")}function ve(e){return U.put("/setting/callback",{data:e})}const be=F({name:"IpArrayInput",props:{modelValue:{type:Array,default:()=>[]},maxItems:{type:Number,default:10}},emits:["update:modelValue"],setup(e,{emit:l}){const s=m(Array(e.modelValue.length).fill("")),i=(r,p)=>r?!$(r,4)&&!$(r,6)?(s.value[p]="请输入有效的IP地址",!1):(s.value[p]="",!0):(s.value[p]="IP地址不能为空",!1);return{ipErrors:s,addItem:()=>{const r=[...e.modelValue,""];s.value.push(""),l("update:modelValue",r)},removeItem:r=>{const p=[...e.modelValue];p.splice(r,1),s.value.splice(r,1),l("update:modelValue",p)},updateItem:(r,p)=>{const V=[...e.modelValue];V[r]=p,l("update:modelValue",V)},validateOnBlur:r=>{i(e.modelValue[r],r)},validate:()=>{if(e.modelValue.length>e.maxItems)return{valid:!1,message:`IP白名单不能超过${e.maxItems}个`};for(let r=0;r<e.modelValue.length;r++)if(!i(e.modelValue[r],r))return{valid:!1,message:s.value[r]};return{valid:!0}}}},render(){return a("div",null,[this.modelValue.map((e,l)=>a("div",{class:"flex flex-col mb-2",key:l},[a("div",{class:"flex items-center"},[a(P("el-input"),{modelValue:e,placeholder:`IP地址 ${l+1}`,"onUpdate:modelValue":s=>this.updateItem(l,s),onBlur:()=>this.validateOnBlur(l),status:this.ipErrors[l]?"error":""},null),a(P("el-button"),{type:"danger",size:"small",plain:!0,class:"ml-2",onClick:()=>this.removeItem(l)},{default:()=>[a(P("el-icon"),null,{default:()=>[a(W,null,null)]})]})]),this.ipErrors[l]&&a("div",{class:"text-red-500 text-xs mt-1"},[this.ipErrors[l]])])),a(P("el-button"),{type:"primary",size:"small",plain:!0,class:"mt-2",onClick:this.addItem},{default:()=>[S("添加IP")]}),this.modelValue.length>this.maxItems&&a("div",{class:"text-red-500 text-xs mt-1"},[S("IP白名单不能超过"),this.maxItems,S("个")])])}}),O=()=>window.location.href.replace("/user/setting","/api/v2"),ye=()=>{const e=m({token:"",allowed_ips:[]}),l=m(),s=[{label:"API地址",prop:"api_url",valueType:"input",fieldProps:{value:O(),disabled:!0},fieldSlots:{suffix:()=>y(h,{circle:!0,type:"primary",plain:!0,link:!0,onClick:()=>{navigator.clipboard.writeText(O()).then(()=>{u("API地址已复制到剪贴板",{type:"success"})}).catch(()=>{u("复制失败",{type:"error"})})}},()=>y(B,{icon:"ep/copy-document"}))}},{label:"API Token",prop:"token",valueType:"input",fieldProps:{placeholder:"请输入API Token"},fieldSlots:{suffix:()=>[y(h,{circle:!0,type:"success",plain:!0,link:!0,onClick:()=>{e.value.token=X(64)}},()=>y(B,{icon:"ep/circle-plus"})),y(h,{circle:!0,type:"primary",plain:!0,link:!0,onClick:()=>{e.value.token?navigator.clipboard.writeText(e.value.token).then(()=>{u("Token已复制到剪贴板",{type:"success"})}).catch(()=>{u("复制失败",{type:"error"})}):u("请先生成Token",{type:"warning"})}},()=>y(B,{icon:"ep/copy-document"}))]}},{label:"IP白名单",prop:"allowed_ips",renderField:(o,c)=>{const w=Array.isArray(o)?o:o?[o]:[];return a(be,{ref:l,modelValue:w,"onUpdate:modelValue":c,maxItems:10},null)}}];D(()=>{n()});const i={token:[{min:32,max:128,message:"请输入32-128个字符",trigger:"blur"}]},d=()=>{me(e.value).then(()=>{u("更新成功",{type:"success"})})},n=()=>{e.value.token="",ce().then(o=>{var c;e.value.allowed_ips=((c=o.data)==null?void 0:c.allowed_ips)||[]})};return{apiValues:e,apiColumns:s,apiRules:i,handleApiUpdate:d,resetApiToken:n}},ge=()=>{const e=m({url:"",token:"",status:0}),l=q(()=>e.value.status===0),s=[{label:"回调地址",prop:"url",valueType:"input",fieldProps:{placeholder:"请输入回调地址",get disabled(){return l.value}}},{label:"回调 Token",prop:"token",valueType:"input",fieldProps:{placeholder:"请输入回调 Token",get disabled(){return l.value}}},{label:"状态",prop:"status",valueType:"switch",fieldProps:{activeValue:1,inactiveValue:0},onChange:o=>{o===0&&(e.value.url="",e.value.token="",e.value.status=0)}}],i=q(()=>({url:[{required:!l.value,message:"请输入回调地址",trigger:"blur"},{pattern:/^https?:\/\/.+/,message:"请输入有效的URL地址（以http://或https://开头）",trigger:"blur"}],token:[{required:!l.value,message:"请输入回调Token",trigger:"blur"},{min:32,max:128,message:"请输入32-128个字符",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"blur"}]}));D(()=>{n()});const d=()=>{ve(e.value).then(()=>{u("更新成功",{type:"success"})})},n=()=>{fe().then(o=>{o!=null&&o.data&&(e.value.url=o.data.url,e.value.token=o.data.token,e.value.status=o.data.status)})};return{callbackValues:e,callbackColumns:s,callbackRules:i,handleCallbackUpdate:d,resetCallback:n}},N=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,M=/^1[3-9]\d{9}$/,he=()=>{const e=m({username:"",email:"",mobile:"",token:""}),l=m(!1),s=m("email"),i=m(""),d=m(0);let n=null;const o=()=>{d.value=60,n=window.setInterval(()=>{d.value--,d.value<=0&&n&&(clearInterval(n),n=null)},1e3)},c=()=>{s.value==="email"?ie({email:e.value.email,type:"bind"}).then(()=>{o(),u("验证码已发送",{type:"success"})}).catch(()=>{u("发送验证码失败",{type:"error"})}):de({mobile:e.value.mobile,type:"bind"}).then(()=>{o(),u("验证码已发送",{type:"success"})}).catch(()=>{u("发送验证码失败",{type:"error"})})},w=()=>{s.value==="email"?ae({email:e.value.email,code:i.value}).then(()=>{l.value=!1,u("绑定成功",{type:"success"})}).catch(()=>{u("绑定失败",{type:"error"})}):oe({mobile:e.value.mobile,code:i.value}).then(()=>{l.value=!1,u("绑定成功",{type:"success"})}).catch(()=>{u("绑定失败",{type:"error"})})},r=f=>{s.value=f,l.value=!0,i.value="",n&&(clearInterval(n),n=null),d.value=0},p=[{label:"用户名",prop:"username",valueType:"input",fieldProps:{placeholder:"请输入用户名"},fieldSlots:{append:()=>y(h,{type:"primary",onClick:()=>{k()}},()=>"保存")}},{label:"邮箱",prop:"email",valueType:"input",fieldProps:{placeholder:"请输入邮箱"},fieldSlots:{append:()=>y(h,{type:"primary",onClick:()=>{_()}},()=>"保存")}},{label:"手机号",prop:"mobile",valueType:"input",fieldProps:{placeholder:"请输入手机号"},fieldSlots:{append:()=>y(h,{type:"primary",onClick:()=>{R()}},()=>"保存")}}];D(()=>{Y().then(f=>{e.value.username=f.data.username,e.value.email=f.data.email,e.value.mobile=f.data.mobile})});const V={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:16,message:"请输入3-16个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{validator:(f,C,v)=>{N.test(C)?v():v(new Error("请输入正确的邮箱格式"))},trigger:"blur"}],mobile:[{required:!0,message:"请输入手机号",trigger:"blur"},{validator:(f,C,v)=>{M.test(C)?v():v(new Error("请输入正确的手机号格式"))},trigger:"blur"}]},k=()=>{se({username:e.value.username}).then(()=>{u("更新成功",{type:"success"})})},_=()=>{if(!N.test(e.value.email)){u("请输入正确的邮箱格式",{type:"error"});return}r("email")},R=()=>{if(!M.test(e.value.mobile)){u("请输入正确的手机号格式",{type:"error"});return}r("mobile")};return{profileValues:e,profileColumns:p,profileRules:V,verifyDialogVisible:l,verifyType:s,verifyCode:i,countdown:d,handleSendCode:c,handleVerifySubmit:w}},we=F({props:{visible:Boolean,type:{type:String,required:!0},countdown:Number,verifyCode:String,onSendCode:Function,onSubmit:Function,onClose:Function,onUpdateVerifyCode:Function},setup(e){return()=>a(te,{modelValue:e.visible,title:e.type==="email"?"绑定邮箱":"绑定手机号",width:"320px",onClose:e.onClose},{default:()=>[a(ee,null,{default:()=>[a(z,null,{default:()=>[a("div",{class:"flex items-center"},[a(le,{modelValue:e.verifyCode,"onUpdate:modelValue":l=>{var s;return(s=e.onUpdateVerifyCode)==null?void 0:s.call(e,l)},placeholder:"请输入验证码",class:"mr-3"},null),a(h,{type:"primary",disabled:e.countdown>0,onClick:e.onSendCode},{default:()=>[e.countdown>0?`${e.countdown}s后重试`:"获取验证码"]})])]}),a(z,null,{default:()=>[a(h,{type:"primary",onClick:e.onSubmit},{default:()=>[S("确认绑定")]})]})]})]})}}),Ve={class:"flex flex-col gap-4"},ke=F({name:"Setting",__name:"index",setup(e){const{profileColumns:l,profileRules:s,profileValues:i,verifyDialogVisible:d,verifyType:n,verifyCode:o,countdown:c,handleSendCode:w,handleVerifySubmit:r}=he(),{passwordColumns:p,passwordRules:V,passwordValues:k,handlePasswordUpdate:_,resetPassword:R}=pe(),{apiColumns:f,apiRules:C,apiValues:v,handleApiUpdate:Z,resetApiToken:j}=ye(),{callbackColumns:H,callbackRules:L,callbackValues:E,handleCallbackUpdate:G,resetCallback:J}=ge();return(Ce,g)=>{const I=P("el-card");return ue(),re("div",Ve,[a(I,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:x(()=>[a(t(T),{modelValue:t(i),"onUpdate:modelValue":g[0]||(g[0]=b=>A(i)?i.value=b:null),columns:t(l),rules:t(s),"label-width":"100","label-position":"right","label-suffix":"","has-footer":!1},null,8,["modelValue","columns","rules"])]),_:1}),a(I,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:x(()=>[a(t(T),{modelValue:t(k),"onUpdate:modelValue":g[1]||(g[1]=b=>A(k)?k.value=b:null),columns:t(p),rules:t(V),"label-width":"100","label-position":"right","label-suffix":"","footer-align":"right","submit-text":"保存","reset-text":"重置",onSubmit:t(_),onReset:t(R)},null,8,["modelValue","columns","rules","onSubmit","onReset"])]),_:1}),a(I,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:x(()=>[a(t(T),{modelValue:t(v),"onUpdate:modelValue":g[2]||(g[2]=b=>A(v)?v.value=b:null),columns:t(f),rules:t(C),"label-width":"100","label-position":"right","label-suffix":"","footer-align":"right","submit-text":"保存","reset-text":"重置",onSubmit:t(Z),onReset:t(j)},null,8,["modelValue","columns","rules","onSubmit","onReset"])]),_:1}),a(I,{shadow:"never",style:{border:"none",paddingTop:"20px"}},{default:x(()=>[a(t(T),{modelValue:t(E),"onUpdate:modelValue":g[3]||(g[3]=b=>A(E)?E.value=b:null),columns:t(H),rules:t(L),"label-width":"100","label-position":"right","label-suffix":"","footer-align":"right","submit-text":"保存","reset-text":"重置",onSubmit:t(G),onReset:t(J)},null,8,["modelValue","columns","rules","onSubmit","onReset"])]),_:1}),a(t(we),{visible:t(d),type:t(n),countdown:t(c),verifyCode:t(o),onSendCode:t(w),onSubmit:t(r),onClose:()=>d.value=!1,onUpdateVerifyCode:b=>o.value=b},null,8,["visible","type","countdown","verifyCode","onSendCode","onSubmit","onClose","onUpdateVerifyCode"])])}}}),Te=ne(ke,[["__scopeId","data-v-a86a83e5"]]);export{Te as default};
